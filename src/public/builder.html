<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Application Builder Dashboard</title>

    <!-- Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --error: #FF3B30;
            --bg-neutral-50: #F5F5F7;
            --surface: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border: rgba(0, 0, 0, 0.06);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --radius: 10px;
        }

        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--surface); color: var(--text-primary); line-height: 1.5; overflow: hidden; }

        /* Header */
        .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
        .header-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        .header-actions { display: flex; gap: 12px; }

        /* Buttons and Inputs */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-secondary { background: var(--bg-neutral-50); color: var(--text-primary); }
        .btn-success { background: var(--success); color: #fff; }
        .btn-inline { padding: 6px 12px; font-size: 12px; }
        .btn:hover { filter: brightness(0.97); }
        .btn-block { width: 100%; }

        .input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--surface); color: var(--text-primary); }
        .input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1); }
        textarea.input { resize: vertical; }

        .muted-small { font-size: 12px; color: var(--text-secondary); }
        .hidden { display: none !important; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); border-radius: 12px; padding: 32px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-md); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; width: 32px; height: 32px; display: grid; place-items: center; border-radius: 6px; }

        /* Page Layout (3 columns) */
        .page { display: grid; grid-template-columns: 240px 1fr 400px; height: calc(100vh - 80px); background: var(--bg-neutral-50); position: relative; }

        /* Resize Handles */
        .resize-handle { position: absolute; top: 0; bottom: 0; width: 8px; cursor: col-resize; z-index: 10; background: var(--border); transition: background 0.2s; }
        .resize-handle:hover, .resize-handle.dragging { background: var(--primary); }
        .resize-handle-left { left: 240px; margin-left: -4px; }
        .resize-handle-right { right: 400px; margin-right: -4px; }

        /* Chat Panel Styles (Right Panel) */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--surface);
            border-left: 1px solid var(--border);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--bg-neutral-50);
        }
        .chat-message {
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.2s ease-out;
        }
        .chat-message.system {
            background: white;
            color: var(--text-primary);
            border-left: 3px solid var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chat-message.user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            max-width: 80%;
        }
        .chat-message.ai {
            background: white;
            color: var(--text-primary);
            border-left: 3px solid var(--success);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chat-message.error {
            background: #FFF5F5;
            color: var(--error);
            border-left: 3px solid var(--error);
        }
        .chat-timestamp {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sidebar */
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: 16px; overflow-y: auto; }
        .section { padding: 12px 0; border-bottom: 1px solid var(--border); }
        .section:last-child { border-bottom: 0; }
        .section-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
        .section-title { font-size: 12px; letter-spacing: 0.6px; font-weight: 700; color: var(--text-primary); text-transform: uppercase; }
        .section-body { margin-top: 12px; overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; }
        .section-body.collapsed { max-height: 0 !important; opacity: 0; margin-top: 0; }
        .accordion-toggle { font-size: 12px; transition: transform 0.3s ease; color: var(--text-secondary); }
        .accordion-toggle.collapsed { transform: rotate(-90deg); }

        .file-tree { font-size: 13px; line-height: 1.6; }
        .file-tree-item { padding: 4px 8px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 6px; }
        .file-tree-item:hover { background: var(--bg-neutral-50); }
        .file-tree-item.active { background: var(--primary); color: #fff; }
        .file-tree-folder { font-weight: 500; }
        .file-tree-children { margin-left: 16px; }
        .file-icon { font-size: 14px; }
        .folder-toggle { cursor: pointer; user-select: none; width: 16px; text-align: center; }

        /* Quality Insights */
        .insight-card { background: var(--bg-neutral-50); padding: 8px; border-radius: 6px; border: 1px solid var(--border); }
        .insight-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .insight-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .quality-bar { width: 100%; height: 6px; background: var(--border); border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .quality-bar-fill { height: 100%; background: linear-gradient(90deg, var(--error) 0%, var(--warning) 50%, var(--success) 100%); transition: width 0.3s ease; }
        .tech-badge { display: inline-block; padding: 2px 8px; background: var(--primary); color: white; border-radius: 12px; font-size: 10px; font-weight: 600; }

        /* Composer (Middle Panel) */
        .composer-wrap {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            background: var(--surface);
        }
        .composer-card {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            display: grid;
            gap: 12px;
        }
        .middle-panel-tab {
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .middle-panel-tab.active {
            display: flex;
        }
        .row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .segmented {
            display: inline-flex;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .segmented .btn {
            border-radius: 0;
        }

        /* Workspace */
        .workspace { background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .tabs { display: flex; border-bottom: 1px solid var(--border); gap: 8px; padding: 8px; }
        .tab { padding: 8px 12px; font-size: 13px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); cursor: pointer; }
        .tab.active { background: var(--bg-neutral-50); border-color: var(--primary); color: var(--primary); }
        .panels { position: relative; flex: 1; }
        .panel-screen { position: absolute; inset: 0; display: none; overflow: hidden; }
        .panel-screen.active { display: block; }
        .panel { background: var(--surface); padding: 16px; height: 100%; display: flex; flex-direction: column; gap: 12px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .panel-body { flex: 1; border-radius: 8px; overflow: hidden; background: var(--bg-neutral-50); }
        .panel-body-inner { width: 100%; height: 100%; border: none; background: #fff; }
        .panel-placeholder { display: grid; place-items: center; height: 100%; color: var(--text-secondary); font-size: 13px; background: var(--bg-neutral-50); }
        .log-body { flex: 1; overflow-y: auto; font-family: 'SF Mono', 'Consolas', monospace; font-size: 12px; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: var(--surface); }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1 class="header-title">üèóÔ∏è Application Builder</h1>
            <p class="header-subtitle">Build applications through natural language conversation</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="openTechnologySettings()">üîß Technologies</button>
            <button class="btn btn-secondary" onclick="openAgentSettings()" id="agent_settings" title="Agent Settings">‚öôÔ∏è Agent Settings</button>
        </div>
    </div>

    <!-- Agent Settings Modal (preserved) -->
    <div id="agent-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ü§ñ Agent Configuration</div>
                <button class="modal-close" onclick="closeAgentSettings()">√ó</button>
            </div>

            <div>
                <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Agent Personality & Behavior</label>
                <p class="muted-small" style="margin-bottom:12px;">Describe how you want the AI assistant to behave. Be specific about tone, expertise level, and interaction style.</p>
                <textarea id="agent-persona" class="input" rows="12" placeholder="Example: Act as a senior full-stack developer who is patient and explains concepts clearly..."></textarea>
            </div>

            <div style="background: var(--bg-neutral-50); padding: 16px; border-radius: 8px; margin: 16px 0;">
                <div style="font-size:13px; font-weight:500; margin-bottom:8px;">üí° Default Persona (Friendly Junior Coder)</div>
                <div class="muted-small" style="line-height:1.6;">A proactive junior developer who asks questions, offers suggestions, and thinks ahead about user needs. Focuses on best practices, debugging help, and encouragement.</div>
            </div>

            <div class="row">
                <button class="btn btn-primary" onclick="saveAgentSettings()" style="flex:1">üíæ Save Settings</button>
                <button class="btn btn-secondary" onclick="resetAgentSettings()">üîÑ Reset to Default</button>
                <button class="btn btn-secondary" onclick="closeAgentSettings()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Technology Settings Modal (preserved) -->
    <div id="technology-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîß Technology Status & Management</div>
                <button class="modal-close" onclick="closeTechnologySettings()">√ó</button>
            </div>

            <div>
                <p class="muted-small" style="margin-bottom:16px;">Monitor and manage the helper technologies that power the Application Builder.</p>
                <div id="technology-list" style="display:flex; flex-direction:column; gap:16px;">
                    <p class="muted-small">Loading technologies...</p>
                </div>
            </div>

            <div class="row" style="justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="refreshTechnologies()">üîÑ Refresh Status</button>
                <button class="btn btn-secondary" onclick="closeTechnologySettings()">Close</button>
            </div>
        </div>
    </div>

    <!-- Page Layout: 3 Columns -->
    <div class="page" id="page">
        <!-- Resize Handles -->
        <div class="resize-handle resize-handle-left" id="resize-left"></div>
        <div class="resize-handle resize-handle-right" id="resize-right"></div>

        <!-- Sidebar (Left) -->
        <aside class="sidebar" id="sidebar">
            <!-- PROJECTS section -->
            <section class="section" id="projects">
                <div class="section-header" onclick="toggleAccordion('project-accordion')">
                    <div class="section-title">PROJECTS</div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="project-accordion" class="section-body">
                    <button class="btn btn-primary btn-block" id="new_project" onclick="newProject()">+ New Project</button>
                    <div id="project-list" class="muted-small" style="max-height:200px; overflow-y:auto; margin-top:12px;">
                        <p>Loading projects...</p>
                    </div>
                </div>
            </section>

            <!-- FILES section -->
            <section class="section" id="files">
                <div class="section-header" onclick="toggleAccordion('files-accordion')">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="section-title">FILES</div>
                        <button class="btn btn-secondary btn-inline" onclick="event.stopPropagation(); updateFileTree();">üîÑ</button>
                    </div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="files-accordion" class="section-body">
                    <div id="file-tree" class="file-tree">
                        <p class="muted-small">No project open</p>
                    </div>
                </div>
            </section>

            <!-- QUALITY INSIGHTS section -->
            <section class="section" id="quality">
                <div class="section-header" onclick="toggleAccordion('quality-accordion')">
                    <div class="section-title">QUALITY INSIGHTS</div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="quality-accordion" class="section-body">
                    <div id="quality-insights" class="muted-small" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Build Status -->
                        <div class="insight-card">
                            <div class="insight-label">Build Status</div>
                            <div id="insight-status" class="insight-value">Ready</div>
                        </div>

                        <!-- Build Time -->
                        <div class="insight-card">
                            <div class="insight-label">‚è±Ô∏è Build Time</div>
                            <div id="insight-build-time" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Quality Score -->
                        <div class="insight-card">
                            <div class="insight-label">‚≠ê Quality Score</div>
                            <div id="insight-quality-score" class="insight-value">‚Äî</div>
                            <div id="insight-quality-bar" class="quality-bar">
                                <div id="insight-quality-fill" class="quality-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- File Stats -->
                        <div class="insight-card">
                            <div class="insight-label">üìÅ Files Generated</div>
                            <div id="insight-file-count" class="insight-value">‚Äî</div>
                        </div>

                        <div class="insight-card">
                            <div class="insight-label">üì¶ Total Size</div>
                            <div id="insight-total-size" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Technologies Detected -->
                        <div class="insight-card">
                            <div class="insight-label">üîß Technologies</div>
                            <div id="insight-technologies" class="insight-value" style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                                <span class="tech-badge">None detected</span>
                            </div>
                        </div>

                        <!-- Iterations (Self-Improvement) -->
                        <div class="insight-card">
                            <div class="insight-label">üîÑ Iterations</div>
                            <div id="insight-iterations" class="insight-value">‚Äî</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PROVIDER METRICS section -->
            <section class="section" id="provider-metrics">
                <div class="section-header" onclick="toggleAccordion('metrics-accordion')">
                    <div class="section-title">PROVIDER METRICS</div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="metrics-accordion" class="section-body">
                    <div id="provider-metrics-content" class="muted-small" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Provider Status -->
                        <div class="insight-card">
                            <div class="insight-label">Status</div>
                            <div id="metrics-status" class="insight-value">Loading...</div>
                        </div>

                        <!-- Total Generations -->
                        <div class="insight-card">
                            <div class="insight-label">üìä Total Generations</div>
                            <div id="metrics-total" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Average Response Time -->
                        <div class="insight-card">
                            <div class="insight-label">‚ö° Avg Response Time</div>
                            <div id="metrics-response-time" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Quality Score -->
                        <div class="insight-card">
                            <div class="insight-label">‚≠ê Avg Quality Score</div>
                            <div id="metrics-quality" class="insight-value">‚Äî</div>
                            <div class="quality-bar">
                                <div id="metrics-quality-fill" class="quality-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Escalations -->
                        <div class="insight-card">
                            <div class="insight-label">üöÄ Escalations</div>
                            <div id="metrics-escalations" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Provider Usage -->
                        <div class="insight-card">
                            <div class="insight-label">üîß Provider Usage</div>
                            <div id="metrics-providers" class="insight-value" style="font-size: 11px; line-height: 1.6;">
                                ‚Äî
                            </div>
                        </div>

                        <!-- Refresh Button -->
                        <button class="btn btn-secondary btn-block btn-inline" onclick="refreshProviderMetrics()">
                            üîÑ Refresh Metrics
                        </button>
                    </div>
                </div>
            </section>
        </aside>

        <!-- Composer (Center) - Build Output & Preview -->
        <main class="composer-wrap" id="composer" style="padding: 0; display: flex; flex-direction: column;">
            <!-- Tabs for Middle Panel -->
            <div class="tabs" style="border-bottom: 1px solid var(--border);">
                <button class="tab active" data-tab="build-log" onclick="switchMiddleTab('build-log')">üìã Build Log</button>
                <button class="tab" data-tab="preview" onclick="switchMiddleTab('preview')">üëÅÔ∏è Preview</button>
                <button class="tab" data-tab="code" onclick="switchMiddleTab('code')">üíª Code</button>
            </div>

            <!-- Middle Panel Content -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;">
                <!-- Build Log Tab -->
                <div class="middle-panel-tab active" id="middle-tab-build-log" style="flex: 1; display: flex; flex-direction: column; background: var(--surface);">
                    <div id="build-log" class="log-body" style="margin: 0; border: none; border-radius: 0; flex: 1;">
                        <p style="color: var(--text-secondary);">Ready to build. Describe what you want in the chat panel ‚Üí</p>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div class="middle-panel-tab" id="middle-tab-preview" style="flex: 1; display: none; flex-direction: column; background: var(--surface);">
                    <div class="panel" id="live_preview" style="height: 100%; margin: 0; border: none; border-radius: 0;">
                        <div class="panel-header">
                            <div class="panel-title">Live Preview</div>
                            <div class="row">
                                <button class="btn btn-secondary btn-inline" onclick="refreshPreview()">üîÑ Refresh</button>
                                <button class="btn btn-secondary btn-inline" onclick="openPreviewInNewTab()">üîó Open</button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <iframe id="preview-iframe" class="panel-body-inner"></iframe>
                            <div id="preview-placeholder" class="panel-placeholder">No preview available</div>
                        </div>
                    </div>
                </div>

                <!-- Code Tab -->
                <div class="middle-panel-tab" id="middle-tab-code" style="flex: 1; display: none; flex-direction: column; background: var(--surface);">
                    <div class="panel" id="code_editor" style="height: 100%; margin: 0; border: none; border-radius: 0;">
                        <div class="panel-header">
                            <div class="panel-title">Code Editor</div>
                            <button class="btn btn-success btn-inline" onclick="saveCurrentFile()">üíæ Save</button>
                        </div>
                        <div id="code-editor" class="panel-body">
                            <div class="panel-placeholder" style="padding:12px;">No file selected</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legacy controls kept and hidden to preserve handlers -->
            <div class="hidden">
                <div id="build-input"></div>
            </div>
        </main>

        <!-- Chat Panel (Right) -->
        <section class="chat-panel" id="chat-panel">
            <!-- Header -->
            <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-primary); background: var(--surface);">
                üí¨ AI Assistant
            </div>

            <!-- Conversation Display Area -->
            <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--bg-neutral-50);">
                <div class="chat-message system">
                    <div>üëã Welcome to the Application Builder!</div>
                    <div class="chat-timestamp">Ready to build</div>
                </div>
            </div>

            <!-- Input Area (Bottom) -->
            <div style="background: var(--surface); border-top: 1px solid var(--border); padding: 16px;">
                <textarea id="prompt_composer" class="input" placeholder="Describe what you want to build..." style="height:100px; font-size:14px; margin-bottom: 12px; resize: vertical;"></textarea>
                <button id="build_app" class="btn btn-primary" onclick="sendBuildRequest()" style="width: 100%;">
                    üöÄ Build
                </button>
            </div>
        </section>
    </div>

    <script>
        // Application Builder Dashboard - v2.0 (Build/Ask toggle removed)
        // Last updated: 2025-12-02
        console.log('üé® Application Builder Dashboard v2.0 loaded');

        // State
        let currentProject = null;
        let currentBuildId = null;
        let buildPollingInterval = null;
        let monacoEditor = null;
        let currentFilePath = null;
        let ws = null; // WebSocket connection

        // Column resize state
        let isResizing = false;
        let currentResizeHandle = null;
        let leftColumnWidth = 240;
        let rightColumnWidth = 400;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

        // Initialize WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            console.log('üîå Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                addBuildLog('üîå Connected to build server');
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('WebSocket message parse error:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                addBuildLog('‚ùå WebSocket connection error');
            };

            ws.onclose = () => {
                console.log('üîå WebSocket disconnected');
                addBuildLog('üîå Disconnected from build server');

                // Reconnect after 3 seconds
                setTimeout(() => {
                    console.log('üîÑ Reconnecting WebSocket...');
                    initializeWebSocket();
                }, 3000);
            };
        }

        // Column Resize Functionality
        function initializeColumnResize() {
            const page = document.getElementById('page');
            const leftHandle = document.getElementById('resize-left');
            const rightHandle = document.getElementById('resize-right');

            // Left handle (sidebar resize)
            leftHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                currentResizeHandle = 'left';
                leftHandle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            // Right handle (preview resize)
            rightHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                currentResizeHandle = 'right';
                rightHandle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            // Mouse move
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const pageRect = page.getBoundingClientRect();

                if (currentResizeHandle === 'left') {
                    // Resize left sidebar
                    const newWidth = e.clientX - pageRect.left;
                    if (newWidth >= 180 && newWidth <= 400) {
                        leftColumnWidth = newWidth;
                        updateColumnWidths();
                    }
                } else if (currentResizeHandle === 'right') {
                    // Resize right preview panel
                    const newWidth = pageRect.right - e.clientX;
                    if (newWidth >= 300 && newWidth <= 800) {
                        rightColumnWidth = newWidth;
                        updateColumnWidths();
                    }
                }
            });

            // Mouse up
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentResizeHandle = null;
                    leftHandle.classList.remove('dragging');
                    rightHandle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        function updateColumnWidths() {
            const page = document.getElementById('page');
            const leftHandle = document.getElementById('resize-left');
            const rightHandle = document.getElementById('resize-right');

            page.style.gridTemplateColumns = `${leftColumnWidth}px 1fr ${rightColumnWidth}px`;
            leftHandle.style.left = `${leftColumnWidth}px`;
            rightHandle.style.right = `${rightColumnWidth}px`;
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            console.log('üì® WebSocket message:', message);

            switch (message.type) {
                case 'build_progress':
                    handleBuildProgress(message.data);
                    break;
                case 'file_change':
                    handleFileChange(message.data);
                    break;
                case 'quality_metric':
                    handleQualityMetric(message.data);
                    break;
                case 'build_complete':
                    handleBuildComplete(message.data);
                    break;
                case 'build_error':
                    handleBuildError(message.data);
                    break;
                default:
                    console.log('Unknown message type:', message.type);
            }
        }

        // Handle build progress updates
        function handleBuildProgress(data) {
            const progressText = data.progress !== undefined ? ` (${data.progress}%)` : '';
            const logType = data.status === 'completed' ? 'success' : data.status === 'failed' ? 'error' : 'info';

            addBuildLog(logType, `${data.message}${progressText}`);

            // Show detailed AI activity in chat panel
            if (data.step === 'planning' && data.status === 'started') {
                addChatMessage('ai', 'ü§î Analyzing your request...');
                addChatMessage('ai', 'üìã Breaking down the task into steps...');
            } else if (data.step === 'planning' && data.status === 'completed') {
                addChatMessage('ai', `‚úÖ Plan created with ${data.stepCount || 'multiple'} steps`);
                if (data.message) {
                    addChatMessage('ai', data.message);
                }
            } else if (data.step === 'execution' && data.status === 'started') {
                addChatMessage('ai', '‚öôÔ∏è Starting to build your application...');
            } else if (data.step === 'execution' && data.status === 'in_progress') {
                // Show detailed execution progress
                if (data.currentStep) {
                    addChatMessage('ai', `üî® ${data.currentStep}`);
                } else {
                    addChatMessage('ai', data.message);
                }
            } else if (data.step === 'completion' && data.status === 'completed') {
                addChatMessage('ai', `üéâ ${data.message}`);
            } else if (data.status === 'failed') {
                addChatMessage('error', `‚ùå ${data.message}`);
            } else if (data.message && data.message.length > 0) {
                // Show any other progress messages
                addChatMessage('ai', data.message);
            }
        }

        // Handle file change notifications
        function handleFileChange(data) {
            const logType = data.action === 'created' ? 'success' : data.action === 'deleted' ? 'warning' : 'info';
            addBuildLog(logType, `File ${data.action}: ${data.path}`);

            // Refresh file tree if this is the current project
            if (currentProject && data.projectId === currentProject.id) {
                updateFileTree();
            }

            // Show detailed file activity in chat
            const fileName = data.path.split('/').pop();
            if (data.action === 'created') {
                addChatMessage('ai', `‚ú® Created ${fileName}`);
            } else if (data.action === 'modified') {
                addChatMessage('ai', `üìù Updated ${fileName}`);
            } else if (data.action === 'deleted') {
                addChatMessage('ai', `üóëÔ∏è Removed ${fileName}`);
            }
        }

        // Handle quality metric updates
        function handleQualityMetric(data) {
            addBuildLog(`üìà ${data.label}: ${data.value}`);
            updateQualityInsights(data);
        }

        // Handle build complete
        function handleBuildComplete(data) {
            addBuildLog(`‚úÖ Build complete (${data.duration}ms)`);
            addChatMessage('system', `‚úÖ Build complete! Generated ${data.files?.length || 0} files`);

            // Update quality insights with build results
            if (data.files) {
                completeQualityInsights(data.files, data);
            }

            updateFileTree();
            updatePreview();
        }

        // Handle build error
        function handleBuildError(data) {
            addBuildLog(`‚ùå Build error: ${data.error}`);
            addChatMessage('system', `‚ùå Build error: ${data.error}`);

            // Update status to error
            qualityInsightsData.status = 'Error';
            renderQualityInsights();
        }

        // Quality Insights State
        let qualityInsightsData = {
            status: 'Ready',
            buildTime: null,
            qualityScore: null,
            fileCount: 0,
            totalSize: 0,
            technologies: [],
            iterations: 0,
            startTime: null
        };

        // Update quality insights display
        function updateQualityInsights(data) {
            // Handle different data types
            if (data.metric) {
                // WebSocket quality metric update
                if (data.metric === 'quality_score') {
                    qualityInsightsData.qualityScore = data.value;
                }
            } else if (data.result) {
                // Full execution result
                qualityInsightsData.qualityScore = data.result.qualityScore || data.qualityScore;
                qualityInsightsData.iterations = data.result.iterations || data.iterations || 0;
            }

            renderQualityInsights();
        }

        function renderQualityInsights() {
            // Status
            document.getElementById('insight-status').textContent = qualityInsightsData.status;
            document.getElementById('insight-status').style.color =
                qualityInsightsData.status === 'Building' ? 'var(--primary)' :
                qualityInsightsData.status === 'Complete' ? 'var(--success)' :
                qualityInsightsData.status === 'Error' ? 'var(--error)' : 'var(--text-secondary)';

            // Build Time
            if (qualityInsightsData.buildTime !== null) {
                document.getElementById('insight-build-time').textContent = `${qualityInsightsData.buildTime}ms`;
            }

            // Quality Score
            if (qualityInsightsData.qualityScore !== null) {
                const score = Math.round(qualityInsightsData.qualityScore * 100);
                document.getElementById('insight-quality-score').textContent = `${score}/100`;
                document.getElementById('insight-quality-fill').style.width = `${score}%`;

                // Color based on score
                const fill = document.getElementById('insight-quality-fill');
                if (score >= 80) fill.style.background = 'var(--success)';
                else if (score >= 60) fill.style.background = 'var(--warning)';
                else fill.style.background = 'var(--error)';
            }

            // File Count
            if (qualityInsightsData.fileCount > 0) {
                document.getElementById('insight-file-count').textContent = qualityInsightsData.fileCount;
            }

            // Total Size
            if (qualityInsightsData.totalSize > 0) {
                document.getElementById('insight-total-size').textContent = formatBytes(qualityInsightsData.totalSize);
            }

            // Technologies
            if (qualityInsightsData.technologies.length > 0) {
                const techContainer = document.getElementById('insight-technologies');
                techContainer.innerHTML = qualityInsightsData.technologies
                    .map(tech => `<span class="tech-badge">${tech}</span>`)
                    .join('');
            }

            // Iterations
            if (qualityInsightsData.iterations > 0) {
                document.getElementById('insight-iterations').textContent =
                    `${qualityInsightsData.iterations} ${qualityInsightsData.iterations > 1 ? '(Improved ‚ú®)' : ''}`;
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function detectTechnologies(files) {
            const techs = new Set();

            files.forEach(file => {
                const ext = file.path.split('.').pop().toLowerCase();
                const fileName = file.path.toLowerCase();

                // Detect by extension
                if (ext === 'html') techs.add('HTML');
                if (ext === 'css') techs.add('CSS');
                if (ext === 'js' || ext === 'jsx') techs.add('JavaScript');
                if (ext === 'ts' || ext === 'tsx') techs.add('TypeScript');
                if (ext === 'py') techs.add('Python');
                if (ext === 'json') techs.add('JSON');
                if (ext === 'md') techs.add('Markdown');

                // Detect frameworks by filename
                if (fileName.includes('react')) techs.add('React');
                if (fileName.includes('vue')) techs.add('Vue');
                if (fileName.includes('angular')) techs.add('Angular');
                if (fileName === 'package.json') techs.add('Node.js');
                if (fileName === 'requirements.txt') techs.add('Python');
                if (fileName === 'dockerfile') techs.add('Docker');
            });

            return Array.from(techs);
        }

        function resetQualityInsights() {
            qualityInsightsData = {
                status: 'Building',
                buildTime: null,
                qualityScore: null,
                fileCount: 0,
                totalSize: 0,
                technologies: [],
                iterations: 0,
                startTime: Date.now()
            };
            renderQualityInsights();
        }

        function completeQualityInsights(files, execution) {
            qualityInsightsData.status = 'Complete';
            qualityInsightsData.buildTime = Date.now() - qualityInsightsData.startTime;
            qualityInsightsData.fileCount = files.length;
            qualityInsightsData.totalSize = files.reduce((sum, f) => sum + (f.size || f.content?.length || 0), 0);
            qualityInsightsData.technologies = detectTechnologies(files);

            if (execution) {
                qualityInsightsData.qualityScore = execution.qualityScore || execution.result?.qualityScore;
                qualityInsightsData.iterations = execution.iterations || execution.result?.iterations || 1;
            }

            renderQualityInsights();
        }

        // ========================================
        // PROVIDER METRICS
        // ========================================

        async function refreshProviderMetrics() {
            try {
                const response = await fetch('/api/builder/metrics/provider');
                const result = await response.json();

                if (!result.success) {
                    console.error('Failed to fetch provider metrics:', result.error);
                    document.getElementById('metrics-status').textContent = 'Error';
                    document.getElementById('metrics-status').style.color = 'var(--error)';
                    return;
                }

                const data = result.data;

                if (!data.enabled) {
                    document.getElementById('metrics-status').textContent = 'Disabled';
                    document.getElementById('metrics-status').style.color = 'var(--text-secondary)';
                    return;
                }

                // Update status
                document.getElementById('metrics-status').textContent = 'Active';
                document.getElementById('metrics-status').style.color = 'var(--success)';

                // Update summary metrics
                const summary = data.summary;
                document.getElementById('metrics-total').textContent = summary.totalGenerations || 0;
                document.getElementById('metrics-response-time').textContent =
                    summary.avgResponseTime ? `${summary.avgResponseTime}ms` : '‚Äî';
                document.getElementById('metrics-quality').textContent =
                    summary.avgQualityScore ? `${summary.avgQualityScore}%` : '‚Äî';
                document.getElementById('metrics-escalations').textContent = summary.escalations || 0;

                // Update quality bar
                if (summary.avgQualityScore) {
                    const fill = document.getElementById('metrics-quality-fill');
                    fill.style.width = `${summary.avgQualityScore}%`;
                }

                // Update provider usage
                const providerUsage = data.providerUsage;
                const providersDiv = document.getElementById('metrics-providers');
                if (Object.keys(providerUsage).length > 0) {
                    const total = Object.values(providerUsage).reduce((sum, count) => sum + count, 0);
                    const usageHtml = Object.entries(providerUsage)
                        .map(([provider, count]) => {
                            const percentage = Math.round((count / total) * 100);
                            const shortName = provider.replace('ollama-', '').replace('qwen2.5-coder:', '');
                            return `<div style="margin-bottom: 4px;">
                                <strong>${shortName}</strong>: ${count} (${percentage}%)
                            </div>`;
                        })
                        .join('');
                    providersDiv.innerHTML = usageHtml;
                } else {
                    providersDiv.innerHTML = '‚Äî';
                }

                console.log('‚úÖ Provider metrics refreshed');
            } catch (error) {
                console.error('Error refreshing provider metrics:', error);
                document.getElementById('metrics-status').textContent = 'Error';
                document.getElementById('metrics-status').style.color = 'var(--error)';
            }
        }

        // Auto-refresh metrics every 10 seconds
        setInterval(refreshProviderMetrics, 10000);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Application Builder Dashboard loaded');
            loadProjects();
            // Monaco editor is now lazy-loaded when Code tab is clicked
            initializeWebSocket();
            initializeColumnResize();
            // Set Build Log as default tab in middle panel
            switchMiddleTab('build-log');
            // Load provider metrics
            refreshProviderMetrics();
        });

        function initializeMonacoEditor() {
            // Prevent multiple initializations
            if (monacoEditor) {
                console.log('Monaco Editor already initialized');
                return;
            }

            console.log('Initializing Monaco Editor...');
            require(['vs/editor/editor.main'], function () {
                const editorContainer = document.getElementById('code-editor');
                editorContainer.innerHTML = '';

                monacoEditor = monaco.editor.create(editorContainer, {
                    value: '// Select a file from the file browser to edit',
                    language: 'javascript',
                    theme: 'vs-light',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 13,
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    readOnly: true
                });

                console.log('‚úÖ Monaco Editor initialized');
            });
        }

        // Project Management and other functions (unchanged)
        function resetUI() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 100px;">Start building by describing what you want to create</p>';

            const buildLog = document.getElementById('build-log');
            buildLog.innerHTML = '<p style="color: var(--text-secondary);">Ready to build</p>';

            const insights = document.getElementById('quality-insights');
            insights.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">No build yet</p>';

            if (monacoEditor) {
                monacoEditor.setValue('');
                monacoEditor.updateOptions({ readOnly: true });
            }

            const previewIframe = document.getElementById('preview-iframe');
            const previewPlaceholder = document.getElementById('preview-placeholder');
            previewIframe.src = '';
            previewPlaceholder.style.display = 'grid';

            currentBuildId = null;
            currentFilePath = null;
            if (buildPollingInterval) {
                clearInterval(buildPollingInterval);
                buildPollingInterval = null;
            }
        }

        async function newProject() {
            console.log('üìÅ newProject called'); // Debug log
            const name = prompt('Enter project name:');
            if (!name) return;

            const description = prompt('Enter project description (optional):') || '';

            try {
                const response = await fetch('/api/builder/projects/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                const result = await response.json();

                if (result.success) {
                    resetUI();
                    currentProject = result.data;
                    addChatMessage('system', `‚úÖ Project "${name}" created`);
                    updateFileTree();
                    loadProjects(); // Refresh project list
                } else {
                    addChatMessage('system', `‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error creating project:', error);
                addChatMessage('system', `‚ùå Error: ${error.message}`);
            }
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/builder/projects');
                const result = await response.json();

                const projectList = document.getElementById('project-list');

                if (result.success && result.data.length > 0) {
                    projectList.innerHTML = '';
                    result.data.forEach(project => {
                        const projectDiv = document.createElement('div');
                        projectDiv.style.padding = '8px';
                        projectDiv.style.marginBottom = '4px';
                        projectDiv.style.background = 'var(--surface)';
                        projectDiv.style.borderRadius = '6px';
                        projectDiv.style.cursor = 'pointer';
                        projectDiv.style.fontSize = '13px';
                        projectDiv.style.transition = 'all 0.2s';
                        projectDiv.innerHTML = `
                            <div style="font-weight: 500; color: var(--text-primary);">${project.name}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${new Date(project.createdAt).toLocaleDateString()}</div>`;
                        projectDiv.onclick = () => selectProject(project);
                        projectDiv.onmouseenter = () => {
                            projectDiv.style.background = 'var(--primary)';
                            projectDiv.style.color = 'white';
                            projectDiv.querySelector('div:first-child').style.color = 'white';
                            projectDiv.querySelector('div:last-child').style.color = 'rgba(255,255,255,0.8)';
                        };
                        projectDiv.onmouseleave = () => {
                            if (!currentProject || currentProject.id !== project.id) {
                                projectDiv.style.background = 'var(--surface)';
                                projectDiv.style.color = 'var(--text-primary)';
                                projectDiv.querySelector('div:first-child').style.color = 'var(--text-primary)';
                                projectDiv.querySelector('div:last-child').style.color = 'var(--text-secondary)';
                            }
                        };
                        projectList.appendChild(projectDiv);
                    });
                } else {
                    projectList.innerHTML = '<p class="muted-small">No projects yet</p>';
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                const projectList = document.getElementById('project-list');
                projectList.innerHTML = '<p style="color: var(--error); font-size: 13px;">Error loading projects</p>';
            }
        }

        function selectProject(project) {
            resetUI();
            currentProject = project;
            addChatMessage('system', `üìÇ Opened project: ${project.name}`);
            updateFileTree();
        }

        function addChatMessage(type, content) {
            const chatMessages = document.getElementById('chat-messages');

            // Clear welcome message on first real message
            const welcomeMsg = chatMessages.querySelector('.chat-message.system');
            if (welcomeMsg && welcomeMsg.textContent.includes('Welcome')) {
                chatMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;

            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);

            const timestamp = document.createElement('div');
            timestamp.className = 'chat-timestamp';
            timestamp.textContent = new Date().toLocaleTimeString();
            messageDiv.appendChild(timestamp);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 100px;">Start building by describing what you want to create below</p>';
            document.getElementById('prompt_composer').value = '';
            document.getElementById('build-log').innerHTML = '<p style="color: var(--text-secondary);">Ready to build</p>';
            conversationHistory = [];
        }

        const DEFAULT_AGENT_PERSONA = `Act as a friendly junior coder in a new app designed to help users build applications. Your role is to be proactive and always think ahead about what users might need. Engage users by asking insightful questions and offering helpful suggestions throughout their coding journey. Focuses on best practices, debugging help, and encouragement.`;
        let agentPersona = localStorage.getItem('agentPersona') || DEFAULT_AGENT_PERSONA;

        function openAgentSettings() { document.getElementById('agent-persona').value = agentPersona; document.getElementById('agent-settings-modal').classList.add('active'); }
        function closeAgentSettings() { document.getElementById('agent-settings-modal').classList.remove('active'); }

        async function openTechnologySettings() { document.getElementById('technology-settings-modal').classList.add('active'); await loadTechnologies(); }
        function closeTechnologySettings() { document.getElementById('technology-settings-modal').classList.remove('active'); }

        async function loadTechnologies() {
            const listEl = document.getElementById('technology-list');
            listEl.innerHTML = '<p class="muted-small">Loading technologies...</p>';
            try {
                const techResponse = await fetch('/api/technologies');
                const techData = await techResponse.json();
                const statusResponse = await fetch('/api/technologies/status');
                const statusData = await statusResponse.json();
                if (!techData.success || !statusData.success) throw new Error('Failed to load technologies');
                const technologies = techData.data; const statuses = statusData.data; const statusMap = {}; statuses.forEach(s => statusMap[s.id] = s);
                listEl.innerHTML = technologies.map(tech => {
                    const status = statusMap[tech.id] || { operational: false, available: false };
                    const isOperational = status.operational; const icon = isOperational ? '‚úÖ' : '‚ùå'; const statusClass = isOperational ? 'operational' : 'not-operational'; const statusText = isOperational ? 'Operational' : 'Not Running';
                    return `
                        <div style="background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; display:flex; gap:20px;">
                            <div style="font-size:32px; width:48px; height:48px; display:grid; place-items:center; border-radius:12px; background:var(--bg-neutral-50); ${isOperational ? 'color: var(--success); background: rgba(52,199,89,.1);' : 'color: var(--error); background: rgba(255,59,48,.1);'}">${icon}</div>
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                                    <div>
                                        <div style="font-size:16px; font-weight:600;">${tech.name}</div>
                                        <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                                            <span style="font-size:12px; ${isOperational ? 'color: var(--success);' : 'color: var(--error);'} font-weight:500;">${statusText}</span>
                                            <span style="font-size:11px; padding:4px 8px; border-radius:6px; ${tech.required ? 'background: rgba(255,149,0,.1); color: var(--warning);' : 'background: rgba(88,86,214,.1); color: var(--secondary);'}">${tech.required ? 'Required' : 'Optional'}</span>
                                            ${status.port ? `<span style="font-size: 11px; color: var(--text-secondary);">Port: ${status.port}</span>` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        ${!isOperational && tech.startCommand ? `<button class=\"btn btn-primary btn-inline\" onclick=\"startTechnology('${tech.id}')\">‚ñ∂Ô∏è Start</button>` : ''}
                                    </div>
                                </div>
                                <div class="muted-small" style="margin-bottom:8px;">${tech.description}</div>
                                <div class="muted-small" style="background: var(--bg-neutral-50); padding:8px 12px; border-radius:8px; margin-bottom:8px;"><strong>Problem Solved:</strong> ${tech.problem}</div>
                                ${tech.paperUrl ? `<a href="${tech.paperUrl}" target="_blank" style="font-size:12px; color: var(--primary); text-decoration:none;">üìÑ ${tech.paperTitle || 'Read Research Paper'} ‚Üí</a>` : ''}
                            </div>
                        </div>`;
                }).join('');
            } catch (error) {
                console.error('Failed to load technologies:', error);
                listEl.innerHTML = `<div style="padding:20px; text-align:center; color: var(--error);"><p>‚ùå Failed to load technologies</p><p class="muted-small" style="margin-top:8px;">${error.message}</p></div>`;
            }
        }

        async function startTechnology(techId) {
            try {
                const response = await fetch(`/api/technologies/${techId}/start`, { method: 'POST' });
                const data = await response.json();
                if (data.success) addChatMessage('system', `‚úÖ ${data.data.message}`); else addChatMessage('system', `‚ùå ${data.error.message}`);
                await loadTechnologies();
            } catch (error) { console.error('Failed to start technology:', error); addChatMessage('system', `‚ùå Failed to start technology: ${error.message}`); }
        }

        async function refreshTechnologies() { await fetch('/api/technologies/cache/clear', { method: 'POST' }); await loadTechnologies(); }

        function saveAgentSettings() {
            const newPersona = document.getElementById('agent-persona').value.trim();
            if (!newPersona) { alert('Please enter an agent persona description'); return; }
            agentPersona = newPersona; localStorage.setItem('agentPersona', agentPersona); closeAgentSettings(); addChatMessage('system', '‚úÖ Agent settings saved! The AI will now use your custom persona.');
        }
        function resetAgentSettings() { if (confirm('Reset to default agent persona?')) { agentPersona = DEFAULT_AGENT_PERSONA; localStorage.removeItem('agentPersona'); document.getElementById('agent-persona').value = DEFAULT_AGENT_PERSONA; addChatMessage('system', 'üîÑ Agent settings reset to default.'); } }

        let conversationHistory = [];
        let qualityMode = false;

        // Mode toggle functions removed - app now always builds

        function toggleQualityMode() {
            qualityMode = !qualityMode;
            const btn = document.getElementById('quality-mode-btn');
            if (btn) {
                if (qualityMode) { btn.textContent = '‚ú® Quality: ON'; btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary'); addChatMessage('system', '‚ú® Quality Mode enabled! Code will be iteratively improved (Pack 11 Phase 2)'); }
                else { btn.textContent = '‚ú® Quality: OFF'; btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); addChatMessage('system', '‚ö° Quality Mode disabled. Using fast generation.'); }
            }
        }

        async function sendBuildRequest() {
            console.log('üöÄ sendBuildRequest called'); // Debug log
            const input = document.getElementById('prompt_composer');
            const request = input.value.trim();

            // Validation with better user feedback
            if (!request) {
                addChatMessage('error', '‚ö†Ô∏è Please enter a build request in the text box above');
                return;
            }

            if (!currentProject) {
                addChatMessage('error', '‚ö†Ô∏è No project selected! Please create a new project first.');
                addChatMessage('system', 'üí° Click the "+ New Project" button in the left sidebar under PROJECTS');
                return;
            }

            // Add user message and clear input
            addChatMessage('user', request);
            input.value = '';

            // Always build (no mode toggle)
            console.log('üî® Calling sendBuildExecute...'); // Debug log
            await sendBuildExecute(request);
        }

        // Chat message function removed - app now always builds

        async function sendBuildExecute(request) {
            resetQualityInsights(); // Reset insights at build start
            addChatMessage('system', qualityMode ? '‚ú® Starting build with quality improvement...' : 'ü§î Starting build...');
            addBuildLog('info', 'Build started');

            try {
                const response = await fetch('/api/builder/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: request,
                        projectId: currentProject?.id,
                        useQuality: qualityMode
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const { duration, files, qualityScore, iterations, improved } = result.data;

                    // Success message
                    const durationSec = (duration / 1000).toFixed(1);
                    let successMsg = `‚úÖ Build complete in ${durationSec}s! Generated ${files.length} files`;

                    if (qualityScore) {
                        const qualityPercent = Math.round(qualityScore * 100);
                        successMsg += ` (Quality: ${qualityPercent}%)`;
                    }

                    if (improved && iterations > 1) {
                        successMsg += ` ‚ú® Improved through ${iterations} iterations`;
                    }

                    addChatMessage('system', successMsg);
                    addBuildLog('success', successMsg);

                    // Update file tree and preview
                    await updateFileTree();
                    await updatePreview();

                    // Switch to preview tab
                    switchWorkspaceTab('preview');

                } else {
                    addChatMessage('ai', `‚ùå Build failed: ${result.error}`);
                    addBuildLog('error', `Build failed: ${result.error}`);
                    qualityInsightsData.status = 'Error';
                    renderQualityInsights();
                }

            } catch (error) {
                console.error('Error sending build request:', error);
                addChatMessage('ai', `‚ùå Error: ${error.message}`);
                addBuildLog('error', `Error: ${error.message}`);
                qualityInsightsData.status = 'Error';
                renderQualityInsights();
            }
        }

        // Legacy endpoints (kept for backward compatibility)
        async function sendBuildWithQuality(request) {
            resetQualityInsights();
            addChatMessage('system', '‚ú® Generating with quality improvement...');
            try {
                const response = await fetch('/api/builder/generate-with-improvement', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: request, projectId: currentProject?.id, maxIterations: 2 }) });
                const result = await response.json();
                if (result.success) {
                    const { code, qualityScore, iterations, improved } = result.data;
                    const qualityPercent = Math.round((qualityScore || 0) * 100);
                    const improvementMsg = improved ? `‚ú® Code improved through ${iterations} iterations (Quality: ${qualityPercent}%)` : `‚úÖ Code generated (Quality: ${qualityPercent}%)`;
                    addChatMessage('system', improvementMsg);
                    addChatMessage('ai', code);
                    addBuildLog('success', improvementMsg);
                    updateQualityInsights({ qualityScore, iterations });
                }
                else { addChatMessage('ai', `‚ùå Error: ${result.error}`); }
            } catch (error) { console.error('Error with quality generation:', error); addChatMessage('ai', `‚ùå Error: ${error.message}`); }
        }

        async function sendBuildDirect(request) {
            resetQualityInsights();
            addChatMessage('system', 'ü§î Analyzing request...');
            try {
                const enhancedTask = `${request}\n\nIMPORTANT: Create all files in the project directory: projects/${currentProject?.name}/\n\nUse the write_file tool to create the following files:\n- index.html (in projects/${currentProject?.name}/)\n- styles.css (in projects/${currentProject?.name}/)\n- script.js (in projects/${currentProject?.name}/)\n\nMake sure to use the write_file tool for each file.`;
                const response = await fetch('/api/agent/execute-async', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task: enhancedTask, userId: 'builder-user' }) });
                const result = await response.json();
                if (result.success) { currentBuildId = result.data.executionId; addChatMessage('system', '‚è≥ Build started...'); addBuildLog('info', 'Build started'); startBuildPolling(); }
                else { addChatMessage('ai', `‚ùå Error: ${result.error}`); }
            } catch (error) { console.error('Error sending build request:', error); addChatMessage('ai', `‚ùå Error: ${error.message}`); }
        }

        function startBuildPolling() {
            if (buildPollingInterval) clearInterval(buildPollingInterval);
            buildPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/agent/status/${currentBuildId}`);
                    const result = await response.json();
                    if (result.success) {
                        const execution = result.data;
                        if (execution.status === 'completed') { clearInterval(buildPollingInterval); handleBuildComplete(execution); }
                        else if (execution.status === 'failed') { clearInterval(buildPollingInterval); handleBuildFailed(execution); }
                    }
                } catch (error) { console.error('Error polling build status:', error); }
            }, 2000);
        }

        async function handleBuildComplete(execution) {
            addChatMessage('ai', '‚úÖ Build completed successfully!');
            addBuildLog('success', 'Build completed');
            if (execution.result && execution.result.output) {
                let outputText = '';
                if (typeof execution.result.output === 'string') outputText = execution.result.output;
                else if (Array.isArray(execution.result.output)) outputText = execution.result.output.map(item => { if (typeof item === 'string') return item; if (item.content) return item.content; if (item.text) return item.text; return JSON.stringify(item, null, 2); }).join('\n\n');
                else outputText = JSON.stringify(execution.result.output, null, 2);
                if (outputText.trim()) addChatMessage('ai', outputText);
            }

            // Get file list for quality insights
            try {
                const response = await fetch(`/api/builder/projects/${currentProject.id}/files`);
                const result = await response.json();
                if (result.success) {
                    completeQualityInsights(result.data, execution);
                }
            } catch (error) {
                console.error('Error getting files for quality insights:', error);
            }

            autoRefreshPreview();
            updateFileTree();
        }

        function handleBuildFailed(execution) { const errorMsg = execution.error || 'Build failed'; addChatMessage('ai', `‚ùå Build failed: ${errorMsg}`); addBuildLog('error', `Build failed: ${errorMsg}`); }

        function addBuildLog(type, message) {
            const buildLog = document.getElementById('build-log');
            if (buildLog.querySelector('p[style*="color: var(--text-secondary)"]')) buildLog.innerHTML = '';
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '4px';
            let icon = '‚ÑπÔ∏è'; let color = 'var(--text-primary)';
            if (type === 'success') { icon = '‚úÖ'; color = 'var(--success)'; }
            else if (type === 'error') { icon = '‚ùå'; color = 'var(--error)'; }
            else if (type === 'warning') { icon = '‚ö†Ô∏è'; color = 'var(--warning)'; }
            logEntry.innerHTML = `<span style="color: var(--text-secondary)">${timestamp}</span> <span style="color: ${color}">${icon} ${message}</span>`;
            buildLog.appendChild(logEntry); buildLog.scrollTop = buildLog.scrollHeight;
        }

        async function updateFileTree() {
            if (!currentProject) { document.getElementById('file-tree').innerHTML = '<p class="muted-small">No project open</p>'; return; }
            try {
                const response = await fetch(`/api/builder/projects/${currentProject.id}/files`);
                const result = await response.json();
                if (result.success) {
                    const fileTree = document.getElementById('file-tree');
                    fileTree.innerHTML = ''; fileTree.className = 'file-tree';
                    renderFileTree(result.data, fileTree);
                }
            } catch (error) { console.error('Error loading file tree:', error); }
        }

        function renderFileTree(items, container, level = 0) {
            items.forEach(item => {
                if (item.type === 'directory') {
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'file-tree-item file-tree-folder';
                    folderDiv.style.paddingLeft = `${level * 12 + 8}px`;
                    const toggle = document.createElement('span'); toggle.className = 'folder-toggle'; toggle.textContent = '‚ñº';
                    const icon = document.createElement('span'); icon.className = 'file-icon'; icon.textContent = 'üìÅ';
                    const name = document.createElement('span'); name.textContent = item.name;
                    folderDiv.appendChild(toggle); folderDiv.appendChild(icon); folderDiv.appendChild(name);
                    const childrenDiv = document.createElement('div'); childrenDiv.className = 'file-tree-children';
                    folderDiv.addEventListener('click', (e) => { e.stopPropagation(); const isOpen = toggle.textContent === '‚ñº'; toggle.textContent = isOpen ? '‚ñ∂' : '‚ñº'; childrenDiv.style.display = isOpen ? 'none' : 'block'; });
                    container.appendChild(folderDiv);
                    if (item.children && item.children.length > 0) { renderFileTree(item.children, childrenDiv, level + 1); container.appendChild(childrenDiv); }
                } else {
                    const fileDiv = document.createElement('div'); fileDiv.className = 'file-tree-item'; fileDiv.style.paddingLeft = `${level * 12 + 32}px`;
                    const icon = document.createElement('span'); icon.className = 'file-icon'; icon.textContent = getFileIcon(item.name);
                    const name = document.createElement('span'); name.textContent = item.name; fileDiv.appendChild(icon); fileDiv.appendChild(name);
                    fileDiv.addEventListener('click', () => { openFile(item.path); document.querySelectorAll('.file-tree-item').forEach(el => el.classList.remove('active')); fileDiv.classList.add('active'); });
                    container.appendChild(fileDiv);
                }
            });
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = { js: 'üìú', ts: 'üìò', json: 'üìã', html: 'üåê', css: 'üé®', md: 'üìù', txt: 'üìÑ', py: 'üêç', java: '‚òï', cpp: '‚öôÔ∏è', c: '‚öôÔ∏è', go: 'üîµ', rs: 'ü¶Ä', sh: 'üîß', yml: '‚öôÔ∏è', yaml: '‚öôÔ∏è', xml: 'üì∞', svg: 'üñºÔ∏è', png: 'üñºÔ∏è', jpg: 'üñºÔ∏è', gif: 'üñºÔ∏è' };
            return icons[ext] || 'üìÑ';
        }

        async function openFile(filePath) {
            if (!monacoEditor) { console.error('Monaco Editor not initialized'); return; }
            try {
                const response = await fetch(`/api/builder/files/${currentProject.id}?path=${encodeURIComponent(filePath)}`);
                if (!response.ok) { addBuildLog('error', `Failed to open file: ${filePath}`); return; }
                const result = await response.json();
                if (result.success) {
                    currentFilePath = filePath;
                    const ext = filePath.split('.').pop().toLowerCase();
                    const languageMap = { js: 'javascript', ts: 'typescript', json: 'json', html: 'html', css: 'css', md: 'markdown', py: 'python', java: 'java', cpp: 'cpp', c: 'c', go: 'go', rs: 'rust', sh: 'shell', yml: 'yaml', yaml: 'yaml', xml: 'xml', txt: 'plaintext' };
                    const language = languageMap[ext] || 'plaintext';
                    monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
                    monacoEditor.setValue(result.data.content);
                    monacoEditor.updateOptions({ readOnly: false });
                    addBuildLog('info', `Opened: ${filePath}`);
                } else { addBuildLog('error', `Error: ${result.error}`); }
            } catch (error) { console.error('Error opening file:', error); addBuildLog('error', `Error opening file: ${error.message}`); }
        }

        async function saveCurrentFile() {
            if (!currentFilePath || !monacoEditor) { alert('No file is currently open'); return; }
            try {
                const content = monacoEditor.getValue();
                const response = await fetch(`/api/builder/files/${currentProject.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: currentFilePath, content }) });
                const result = await response.json();
                if (result.success) addBuildLog('success', `Saved: ${currentFilePath}`); else addBuildLog('error', `Save failed: ${result.error}`);
            } catch (error) { console.error('Error saving file:', error); addBuildLog('error', `Error saving file: ${error.message}`); }
        }

        // Removed duplicate updateQualityInsights - using comprehensive version above

        function refreshPreview() {
            if (!currentProject) { alert('No project is open'); return; }
            const iframe = document.getElementById('preview-iframe');
            const placeholder = document.getElementById('preview-placeholder');
            const previewUrl = `/projects/${currentProject.name}/index.html`;
            iframe.src = previewUrl;
            iframe.onload = () => { placeholder.style.display = 'none'; addBuildLog('info', 'Preview refreshed'); };
            iframe.onerror = () => { placeholder.style.display = 'grid'; addBuildLog('warning', 'No index.html found in project'); };
        }

        function openPreviewInNewTab() { if (!currentProject) { alert('No project is open'); return; } const previewUrl = `/projects/${currentProject.name}/index.html`; window.open(previewUrl, '_blank'); }
        function autoRefreshPreview() { setTimeout(() => { refreshPreview(); switchWorkspaceTab('preview'); }, 500); }
        function updatePreview() { autoRefreshPreview(); }

        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const toggle = content.previousElementSibling.querySelector('.accordion-toggle');
            const isCollapsed = content.classList.contains('collapsed');

            if (isCollapsed) {
                // Expand
                content.classList.remove('collapsed');
                if (toggle) toggle.classList.remove('collapsed');
            } else {
                // Collapse
                content.classList.add('collapsed');
                if (toggle) toggle.classList.add('collapsed');
            }
        }

        function showModeHelp() { document.getElementById('mode-help-modal').style.display = 'flex'; }
        function closeModeHelp() { document.getElementById('mode-help-modal').style.display = 'none'; }

        // Switch between middle panel tabs (Build Log, Preview, Code)
        function switchMiddleTab(name) {
            // Update tab buttons
            document.querySelectorAll('#composer .tab').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === name);
            });

            // Update tab content
            document.querySelectorAll('.middle-panel-tab').forEach(panel => {
                if (panel.id === `middle-tab-${name}`) {
                    panel.style.display = 'flex';
                } else {
                    panel.style.display = 'none';
                }
            });

            // Lazy-load Monaco editor when Code tab is clicked
            if (name === 'code' && !monacoEditor) {
                loadMonacoEditor();
            }
        }

        // Legacy function kept for compatibility (no longer used)
        function switchWorkspaceTab(name) {
            // This function is now handled by switchMiddleTab
            switchMiddleTab(name);
        }

        document.addEventListener('click', (e) => { const modal = document.getElementById('mode-help-modal'); if (e.target === modal) closeModeHelp(); });
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendBuildRequest(); }
            if ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 's')) { e.preventDefault(); saveCurrentFile(); }
            if (e.key === 'Escape') { closeModeHelp(); }
        });
    </script>

    <!-- Mode Help Modal (preserved) -->
    <div id="mode-help-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3>üéØ Understanding the Modes</h3>
            <h4>üí¨ Chat Mode (Proactive)</h4>
            <p class="muted-small">The AI acts like a helpful assistant who asks questions and gives suggestions.</p>
            <strong>When to use:</strong>
            <ul class="muted-small">
                <li>When you're not sure exactly what you want</li>
                <li>When you want ideas and suggestions</li>
                <li>When you need help planning your project</li>
                <li>When you want to discuss options before building</li>
            </ul>
            <div style="background: var(--bg-neutral-50); border-left: 3px solid var(--primary); padding: 12px; border-radius: 4px; margin: 12px 0;" class="muted-small">
                <strong>Example:</strong><br>
                You: "I want to create a website for my business"<br><br>
                AI: I'd love to help! A few questions: 1) What type of business? 2) Contact form? 3) Responsive? 4) Showcase products or services?
            </div>
            <h4>üî® Build Mode (Direct)</h4>
            <p class="muted-small">The AI immediately starts building what you ask for without asking questions.</p>
            <h4>‚ú® Quality Mode (ON/OFF)</h4>
            <p class="muted-small">When ON, the AI reviews and improves its own code before giving it to you.</p>
            <div style="text-align:center; margin-top: 16px;">
                <button class="btn btn-primary" onclick="closeModeHelp()">Got it!</button>
            </div>
        </div>
    </div>
</body>
</html>