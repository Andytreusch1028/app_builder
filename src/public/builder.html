<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Application Builder Dashboard</title>

    <!-- Favicon (data URI to prevent 404 error) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">

    <!-- Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --error: #FF3B30;
            --bg-neutral-50: #F5F5F7;
            --surface: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border: rgba(0, 0, 0, 0.06);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --radius: 10px;
        }

        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--surface); color: var(--text-primary); line-height: 1.5; overflow: hidden; }

        /* Header */
        .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
        .header-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        .header-actions { display: flex; gap: 12px; }

        /* Buttons and Inputs */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-secondary { background: var(--bg-neutral-50); color: var(--text-primary); }
        .btn-success { background: var(--success); color: #fff; }
        .btn-inline { padding: 6px 12px; font-size: 12px; }
        .btn:hover { filter: brightness(0.97); }
        .btn-block { width: 100%; }

        .input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--surface); color: var(--text-primary); }
        .input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1); }
        textarea.input { resize: vertical; }

        .muted-small { font-size: 12px; color: var(--text-secondary); }
        .hidden { display: none !important; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); border-radius: 12px; padding: 32px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-md); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; width: 32px; height: 32px; display: grid; place-items: center; border-radius: 6px; }

        /* Page Layout (3 columns) */
        .page { display: grid; grid-template-columns: 240px 1fr 400px; height: calc(100vh - 80px); background: var(--bg-neutral-50); position: relative; }

        /* Resize Handles */
        .resize-handle { position: absolute; top: 0; bottom: 0; width: 8px; cursor: col-resize; z-index: 10; background: var(--border); transition: background 0.2s; }
        .resize-handle:hover, .resize-handle.dragging { background: var(--primary); }
        .resize-handle-left { left: 240px; margin-left: -4px; }
        .resize-handle-right { right: 400px; margin-right: -4px; }

        /* Chat Panel Styles (Right Panel) */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--surface);
            border-left: 1px solid var(--border);
            overflow: hidden; /* Prevent overflow */
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--bg-neutral-50);
            min-height: 0; /* Allow flex shrinking */
        }
        .chat-input-area {
            flex-shrink: 0; /* Never shrink */
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 16px;
        }
        .chat-message {
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            animation: slideIn 0.2s ease-out;
        }
        .chat-message.system {
            background: white;
            color: var(--text-primary);
            border-left: 3px solid var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chat-message.user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            max-width: 80%;
        }
        .chat-message.ai {
            background: white;
            color: var(--text-primary);
            border-left: 3px solid var(--success);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chat-message.error {
            background: #FFF5F5;
            color: var(--error);
            border-left: 3px solid var(--error);
        }
        .chat-timestamp {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sidebar */
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: 16px; overflow-y: auto; }
        .section { padding: 12px 0; border-bottom: 1px solid var(--border); }
        .section:last-child { border-bottom: 0; }
        .section-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
        .section-title { font-size: 12px; letter-spacing: 0.6px; font-weight: 700; color: var(--text-primary); text-transform: uppercase; }
        .section-body { margin-top: 12px; overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; }
        .section-body.collapsed { max-height: 0 !important; opacity: 0; margin-top: 0; }
        .accordion-toggle { font-size: 12px; transition: transform 0.3s ease; color: var(--text-secondary); }
        .accordion-toggle.collapsed { transform: rotate(-90deg); }

        .file-tree { font-size: 13px; line-height: 1.6; }
        .file-tree-item { padding: 4px 8px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 6px; }
        .file-tree-item:hover { background: var(--bg-neutral-50); }
        .file-tree-item.active { background: var(--primary); color: #fff; }
        .file-tree-folder { font-weight: 500; }
        .file-tree-children { margin-left: 16px; }
        .file-icon { font-size: 14px; }
        .folder-toggle { cursor: pointer; user-select: none; width: 16px; text-align: center; }

        /* Quality Insights */
        .insight-card { background: var(--bg-neutral-50); padding: 8px; border-radius: 6px; border: 1px solid var(--border); }
        .insight-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .insight-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .quality-bar { width: 100%; height: 6px; background: var(--border); border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .quality-bar-fill { height: 100%; background: linear-gradient(90deg, var(--error) 0%, var(--warning) 50%, var(--success) 100%); transition: width 0.3s ease; }
        .tech-badge { display: inline-block; padding: 2px 8px; background: var(--primary); color: white; border-radius: 12px; font-size: 10px; font-weight: 600; }

        /* Composer (Middle Panel) */
        .composer-wrap {
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            background: var(--surface);
        }
        .composer-card {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            display: grid;
            gap: 12px;
        }
        .middle-panel-tab {
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .middle-panel-tab.active {
            display: flex;
        }
        .row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .segmented {
            display: inline-flex;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .segmented .btn {
            border-radius: 0;
        }

        /* Workspace */
        .workspace { background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .tabs { display: flex; border-bottom: 1px solid var(--border); gap: 8px; padding: 8px; }
        .tab { padding: 8px 12px; font-size: 13px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); cursor: pointer; }
        .tab.active { background: var(--bg-neutral-50); border-color: var(--primary); color: var(--primary); }
        .panels { position: relative; flex: 1; }
        .panel-screen { position: absolute; inset: 0; display: none; overflow: hidden; }
        .panel-screen.active { display: block; }
        .panel { background: var(--surface); padding: 16px; height: 100%; display: flex; flex-direction: column; gap: 12px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .panel-body { flex: 1; border-radius: 8px; overflow: hidden; background: var(--bg-neutral-50); }
        .panel-body-inner { width: 100%; height: 100%; border: none; background: #fff; }
        .panel-placeholder { display: grid; place-items: center; height: 100%; color: var(--text-secondary); font-size: 13px; background: var(--bg-neutral-50); }
        .log-body { flex: 1; overflow-y: auto; font-family: 'SF Mono', 'Consolas', monospace; font-size: 12px; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: var(--surface); }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1 class="header-title">üèóÔ∏è Application Builder</h1>
            <p class="header-subtitle">Build applications through natural language conversation</p>
        </div>
        <div class="header-actions">
            <div style="position: relative;">
                <button class="btn btn-secondary" onclick="toggleOptionsMenu()" id="options-menu-btn" title="Options">‚öôÔ∏è Options</button>
                <div id="options-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000;">
                    <div style="padding: 8px 0;">
                        <button onclick="openAgentSettings(); closeOptionsMenu();" style="width: 100%; text-align: left; padding: 12px 16px; background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='var(--bg-neutral-50)'" onmouseout="this.style.background='none'">
                            <span>ü§ñ</span>
                            <span>Agent Settings</span>
                        </button>
                        <button onclick="openTechnologySettings(); closeOptionsMenu();" style="width: 100%; text-align: left; padding: 12px 16px; background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='var(--bg-neutral-50)'" onmouseout="this.style.background='none'">
                            <span>üîß</span>
                            <span>Technologies</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Settings Modal (preserved) -->
    <div id="agent-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ü§ñ Agent Configuration</div>
                <button class="modal-close" onclick="closeAgentSettings()">√ó</button>
            </div>

            <div>
                <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Agent Personality & Behavior</label>
                <p class="muted-small" style="margin-bottom:12px;">Describe how you want the AI assistant to behave. Be specific about tone, expertise level, and interaction style.</p>
                <textarea id="agent-persona" class="input" rows="12" placeholder="Example: Act as a senior full-stack developer who is patient and explains concepts clearly..."></textarea>
            </div>

            <div style="background: var(--bg-neutral-50); padding: 16px; border-radius: 8px; margin: 16px 0;">
                <div style="font-size:13px; font-weight:500; margin-bottom:8px;">üí° Default Persona (Friendly Junior Coder)</div>
                <div class="muted-small" style="line-height:1.6;">A proactive junior developer who asks questions, offers suggestions, and thinks ahead about user needs. Focuses on best practices, debugging help, and encouragement.</div>
            </div>

            <div class="row">
                <button class="btn btn-primary" onclick="saveAgentSettings()" style="flex:1">üíæ Save Settings</button>
                <button class="btn btn-secondary" onclick="resetAgentSettings()">üîÑ Reset to Default</button>
                <button class="btn btn-secondary" onclick="closeAgentSettings()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Technology Settings Modal (preserved) -->
    <div id="technology-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîß Technology Status & Management</div>
                <button class="modal-close" onclick="closeTechnologySettings()">√ó</button>
            </div>

            <div>
                <p class="muted-small" style="margin-bottom:16px;">Monitor and manage the helper technologies that power the Application Builder.</p>
                <div id="technology-list" style="display:flex; flex-direction:column; gap:16px;">
                    <p class="muted-small">Loading technologies...</p>
                </div>
            </div>

            <div class="row" style="justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="refreshTechnologies()">üîÑ Refresh Status</button>
                <button class="btn btn-secondary" onclick="closeTechnologySettings()">Close</button>
            </div>
        </div>
    </div>

    <!-- Page Layout: 3 Columns -->
    <div class="page" id="page">
        <!-- Resize Handles -->
        <div class="resize-handle resize-handle-left" id="resize-left"></div>
        <div class="resize-handle resize-handle-right" id="resize-right"></div>

        <!-- Sidebar (Left) -->
        <aside class="sidebar" id="sidebar">
            <!-- PROJECTS section -->
            <section class="section" id="projects">
                <div class="section-header" onclick="toggleAccordion('project-accordion')">
                    <div class="section-title">PROJECTS</div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="project-accordion" class="section-body">
                    <button class="btn btn-primary btn-block" id="new_project" onclick="newProject()">+ New Project</button>
                    <div id="project-list" class="muted-small" style="max-height:200px; overflow-y:auto; margin-top:12px;">
                        <p>Loading projects...</p>
                    </div>
                </div>
            </section>

            <!-- FILES section -->
            <section class="section" id="files">
                <div class="section-header" onclick="toggleAccordion('files-accordion')">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="section-title">FILES</div>
                        <button class="btn btn-secondary btn-inline" onclick="event.stopPropagation(); updateFileTree();">üîÑ</button>
                    </div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="files-accordion" class="section-body">
                    <div id="file-tree" class="file-tree">
                        <p class="muted-small">No project open</p>
                    </div>
                </div>
            </section>

            <!-- QUALITY INSIGHTS section -->
            <section class="section" id="quality">
                <div class="section-header" onclick="toggleAccordion('quality-accordion')">
                    <div class="section-title">QUALITY INSIGHTS</div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="quality-accordion" class="section-body">
                    <div id="quality-insights" class="muted-small" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Build Status -->
                        <div class="insight-card">
                            <div class="insight-label">Build Status</div>
                            <div id="insight-status" class="insight-value">Ready</div>
                        </div>

                        <!-- Build Time -->
                        <div class="insight-card">
                            <div class="insight-label">‚è±Ô∏è Build Time</div>
                            <div id="insight-build-time" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Quality Score -->
                        <div class="insight-card">
                            <div class="insight-label">‚≠ê Quality Score</div>
                            <div id="insight-quality-score" class="insight-value">‚Äî</div>
                            <div id="insight-quality-bar" class="quality-bar">
                                <div id="insight-quality-fill" class="quality-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- File Stats -->
                        <div class="insight-card">
                            <div class="insight-label">üìÅ Files Generated</div>
                            <div id="insight-file-count" class="insight-value">‚Äî</div>
                        </div>

                        <div class="insight-card">
                            <div class="insight-label">üì¶ Total Size</div>
                            <div id="insight-total-size" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Technologies Detected -->
                        <div class="insight-card">
                            <div class="insight-label">üîß Technologies</div>
                            <div id="insight-technologies" class="insight-value" style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                                <span class="tech-badge">None detected</span>
                            </div>
                        </div>

                        <!-- Iterations (Self-Improvement) -->
                        <div class="insight-card">
                            <div class="insight-label">üîÑ Iterations</div>
                            <div id="insight-iterations" class="insight-value">‚Äî</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PROVIDER METRICS section -->
            <section class="section" id="provider-metrics">
                <div class="section-header" onclick="toggleAccordion('metrics-accordion')">
                    <div class="section-title">PROVIDER METRICS</div>
                    <span class="accordion-toggle">‚ñº</span>
                </div>
                <div id="metrics-accordion" class="section-body">
                    <div id="provider-metrics-content" class="muted-small" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Provider Status -->
                        <div class="insight-card">
                            <div class="insight-label">Status</div>
                            <div id="metrics-status" class="insight-value">Loading...</div>
                        </div>

                        <!-- Total Generations -->
                        <div class="insight-card">
                            <div class="insight-label">üìä Total Generations</div>
                            <div id="metrics-total" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Average Response Time -->
                        <div class="insight-card">
                            <div class="insight-label">‚ö° Avg Response Time</div>
                            <div id="metrics-response-time" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Quality Score -->
                        <div class="insight-card">
                            <div class="insight-label">‚≠ê Avg Quality Score</div>
                            <div id="metrics-quality" class="insight-value">‚Äî</div>
                            <div class="quality-bar">
                                <div id="metrics-quality-fill" class="quality-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Escalations -->
                        <div class="insight-card">
                            <div class="insight-label">üöÄ Escalations</div>
                            <div id="metrics-escalations" class="insight-value">‚Äî</div>
                        </div>

                        <!-- Provider Usage -->
                        <div class="insight-card">
                            <div class="insight-label">üîß Provider Usage</div>
                            <div id="metrics-providers" class="insight-value" style="font-size: 11px; line-height: 1.6;">
                                ‚Äî
                            </div>
                        </div>

                        <!-- Refresh Button -->
                        <button class="btn btn-secondary btn-block btn-inline" onclick="refreshProviderMetrics()">
                            üîÑ Refresh Metrics
                        </button>
                    </div>
                </div>
            </section>
        </aside>

        <!-- Composer (Center) - Build Output & Preview -->
        <main class="composer-wrap" id="composer" style="padding: 0; display: flex; flex-direction: column;">
            <!-- Tabs for Middle Panel -->
            <div class="tabs" style="border-bottom: 1px solid var(--border);">
                <button class="tab active" data-tab="planning" onclick="switchMiddleTab('planning')">üìù Planning</button>
                <button class="tab" data-tab="build-log" onclick="switchMiddleTab('build-log')">üìã Build Log</button>
                <button class="tab" data-tab="code" onclick="switchMiddleTab('code')">üíª Code</button>
                <button class="tab" data-tab="preview" onclick="switchMiddleTab('preview')">üëÅÔ∏è Preview</button>
            </div>

            <!-- Middle Panel Content -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;">
                <!-- Planning Tab -->
                <div class="middle-panel-tab active" id="middle-tab-planning" style="flex: 1; display: flex; flex-direction: column; background: var(--surface); overflow-y: auto; padding: 20px;">
                    <!-- Planning Header -->
                    <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 16px; font-weight: 600;">üìù Project Plan</h3>
                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 13px;">
                            Auto-generated from your build request. To modify, use the chat on the right and click ‚û°Ô∏è
                        </p>
                    </div>

                    <!-- Planning Content (READ-ONLY) -->
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 400px;">
                        <div id="planning-content" style="flex: 1; background: var(--bg-neutral-50); padding: 20px; border-radius: 8px; border: 1px solid var(--border); font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; overflow-y: auto; color: var(--text-primary);">
                            <div style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
                                <div style="font-size: 14px; font-family: system-ui, -apple-system, sans-serif;">
                                    No plan generated yet.<br><br>
                                    Enter your build request in the chat on the right and click ‚û°Ô∏è to get started.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Build Log Tab -->
                <div class="middle-panel-tab" id="middle-tab-build-log" style="flex: 1; display: none; flex-direction: column; background: var(--surface);">
                    <div id="build-log" class="log-body" style="margin: 0; border: none; border-radius: 0; flex: 1;">
                        <p style="color: var(--text-secondary);">Ready to build. Describe what you want in the chat panel ‚Üí</p>
                    </div>
                </div>

                <!-- Code Tab -->
                <div class="middle-panel-tab" id="middle-tab-code" style="flex: 1; display: none; flex-direction: column; background: var(--surface);">
                    <div class="panel" id="code_editor" style="height: 100%; margin: 0; border: none; border-radius: 0;">
                        <div class="panel-header">
                            <div class="panel-title">Code Editor</div>
                            <button class="btn btn-success btn-inline" onclick="saveCurrentFile()">üíæ Save</button>
                        </div>
                        <div id="code-editor" class="panel-body">
                            <div class="panel-placeholder" style="padding:12px;">No file selected</div>
                        </div>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div class="middle-panel-tab" id="middle-tab-preview" style="flex: 1; display: none; flex-direction: column; background: var(--surface);">
                    <div class="panel" id="live_preview" style="height: 100%; margin: 0; border: none; border-radius: 0;">
                        <div class="panel-header">
                            <div class="panel-title">Live Preview</div>
                            <div class="row">
                                <button class="btn btn-secondary btn-inline" onclick="refreshPreview()">üîÑ Refresh</button>
                                <button class="btn btn-secondary btn-inline" onclick="openPreviewInNewTab()">üîó Open</button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <iframe id="preview-iframe" class="panel-body-inner"></iframe>
                            <div id="preview-placeholder" class="panel-placeholder">No preview available</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legacy controls kept and hidden to preserve handlers -->
            <div class="hidden">
                <div id="build-input"></div>
            </div>
        </main>

        <!-- Chat Panel (Right) -->
        <section class="chat-panel" id="chat-panel">
            <!-- Header -->
            <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-primary); background: var(--surface);">
                üí¨ AI Assistant
            </div>

            <!-- Conversation Display Area -->
            <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--bg-neutral-50);">
                <div class="chat-message system">
                    <div>üëã Welcome to the Application Builder!</div>
                    <div class="chat-timestamp">Ready to build</div>
                </div>
            </div>

            <!-- Input Area (Bottom) - ALWAYS VISIBLE -->
            <div class="chat-input-area">
                <!-- UI/UX Template Selector -->
                <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label for="ui_template_selector" style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary);">
                            UI/UX Style (Optional)
                        </label>
                        <select id="ui_template_selector" class="input" style="height: 40px; padding: 8px 12px; font-size: 14px;">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div style="padding-top: 26px;">
                        <button id="preview_template_btn" class="btn" onclick="previewTemplate()" style="height: 40px; padding: 8px 16px; font-size: 14px; background: var(--bg-neutral-100); border: 1px solid var(--border);" disabled>
                            üëÅÔ∏è Preview
                        </button>
                    </div>
                </div>

                <!-- Custom UI/UX Instructions (Collapsible) -->
                <div style="margin-bottom: 12px;">
                    <button id="toggle_custom_ui_btn" class="btn" onclick="toggleCustomUIInstructions()" style="width: 100%; text-align: left; padding: 8px 12px; font-size: 13px; background: var(--bg-neutral-50); border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <span>‚ûï Add Custom UI/UX Instructions</span>
                        <span id="custom_ui_toggle_icon">‚ñº</span>
                    </button>
                    <div id="custom_ui_instructions_container" style="display: none; margin-top: 8px;">
                        <textarea id="custom_ui_instructions" class="input" placeholder="Add custom UI/UX instructions here (e.g., 'Use dark mode', 'Add animations', 'Mobile-first design')..." style="height: 80px; font-size: 13px; resize: vertical;"></textarea>
                        <p class="muted-small" style="margin-top: 6px; font-size: 11px;">
                            üí° These instructions will be combined with the selected template (if any)
                        </p>
                    </div>
                </div>

                <!-- Build Request Input -->
                <textarea id="prompt_composer" class="input" placeholder="Describe what you want to build..." style="height:100px; font-size:14px; margin-bottom: 12px; resize: vertical;"></textarea>

                <!-- Build Button -->
                <button id="build_app" class="btn btn-primary" onclick="sendBuildRequest()" style="width: 100%; font-size: 20px; padding: 12px;">
                    ‚û°Ô∏è
                </button>
            </div>
        </section>
    </div>

    <script>
        // Application Builder Dashboard - v2.0 (Build/Ask toggle removed)
        // Last updated: 2025-12-02
        console.log('üé® Application Builder Dashboard v2.0 loaded');

        // State
        let currentProject = null;
        let currentBuildId = null;
        let buildPollingInterval = null;
        let monacoEditor = null;
        let currentFilePath = null;
        let ws = null; // WebSocket connection

        // Column resize state
        let isResizing = false;
        let currentResizeHandle = null;
        let leftColumnWidth = 240;
        let rightColumnWidth = 400;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

        // Initialize WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            console.log('üîå Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                addBuildLog('üîå Connected to build server');
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('WebSocket message parse error:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                addBuildLog('‚ùå WebSocket connection error');
            };

            ws.onclose = () => {
                console.log('üîå WebSocket disconnected');
                addBuildLog('üîå Disconnected from build server');

                // Reconnect after 3 seconds
                setTimeout(() => {
                    console.log('üîÑ Reconnecting WebSocket...');
                    initializeWebSocket();
                }, 3000);
            };
        }

        // Column Resize Functionality
        function initializeColumnResize() {
            const page = document.getElementById('page');
            const leftHandle = document.getElementById('resize-left');
            const rightHandle = document.getElementById('resize-right');

            // Left handle (sidebar resize)
            leftHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                currentResizeHandle = 'left';
                leftHandle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            // Right handle (preview resize)
            rightHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                currentResizeHandle = 'right';
                rightHandle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            // Mouse move
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const pageRect = page.getBoundingClientRect();

                if (currentResizeHandle === 'left') {
                    // Resize left sidebar
                    const newWidth = e.clientX - pageRect.left;
                    if (newWidth >= 180 && newWidth <= 400) {
                        leftColumnWidth = newWidth;
                        updateColumnWidths();
                    }
                } else if (currentResizeHandle === 'right') {
                    // Resize right preview panel
                    const newWidth = pageRect.right - e.clientX;
                    if (newWidth >= 300 && newWidth <= 800) {
                        rightColumnWidth = newWidth;
                        updateColumnWidths();
                    }
                }
            });

            // Mouse up
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentResizeHandle = null;
                    leftHandle.classList.remove('dragging');
                    rightHandle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        function updateColumnWidths() {
            const page = document.getElementById('page');
            const leftHandle = document.getElementById('resize-left');
            const rightHandle = document.getElementById('resize-right');

            page.style.gridTemplateColumns = `${leftColumnWidth}px 1fr ${rightColumnWidth}px`;
            leftHandle.style.left = `${leftColumnWidth}px`;
            rightHandle.style.right = `${rightColumnWidth}px`;
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            console.log('üì® WebSocket message:', message);

            switch (message.type) {
                case 'ping':
                    // Server ping to keep connection alive - no action needed
                    console.log('üíì Server ping received');
                    break;
                case 'build_progress':
                    handleBuildProgress(message.data);
                    break;
                case 'file_change':
                    handleFileChange(message.data);
                    break;
                case 'quality_metric':
                    handleQualityMetric(message.data);
                    break;
                case 'build_complete':
                    handleBuildComplete(message.data);
                    break;
                case 'build_error':
                    handleBuildError(message.data);
                    break;
                default:
                    console.log('Unknown message type:', message.type);
            }
        }

        // Handle build progress updates
        function handleBuildProgress(data) {
            const progressText = data.progress !== undefined ? ` (${data.progress}%)` : '';
            const logType = data.status === 'completed' ? 'success' : data.status === 'failed' ? 'error' : 'info';

            addBuildLog(logType, `${data.message}${progressText}`);

            // Show detailed AI activity in chat panel
            if (data.step === 'planning' && data.status === 'started') {
                addChatMessage('ai', 'ü§î Analyzing your request...');
                addChatMessage('ai', 'üìã Breaking down the task into steps...');
            } else if (data.step === 'planning' && data.status === 'completed') {
                addChatMessage('ai', `‚úÖ Plan created with ${data.stepCount || 'multiple'} steps`);
                if (data.message) {
                    addChatMessage('ai', data.message);
                }
            } else if (data.step === 'execution' && data.status === 'started') {
                addChatMessage('ai', '‚öôÔ∏è Starting to build your application...');
            } else if (data.step === 'execution' && data.status === 'in_progress') {
                // Show detailed execution progress
                if (data.currentStep) {
                    addChatMessage('ai', `üî® ${data.currentStep}`);
                } else {
                    addChatMessage('ai', data.message);
                }
            } else if (data.step === 'completion' && data.status === 'completed') {
                addChatMessage('ai', `üéâ ${data.message}`);
            } else if (data.status === 'failed') {
                addChatMessage('error', `‚ùå ${data.message}`);
            } else if (data.message && data.message.length > 0) {
                // Show any other progress messages
                addChatMessage('ai', data.message);
            }
        }

        // Handle file change notifications
        function handleFileChange(data) {
            const logType = data.action === 'created' ? 'success' : data.action === 'deleted' ? 'warning' : 'info';
            addBuildLog(logType, `File ${data.action}: ${data.path}`);

            // Refresh file tree if this is the current project
            if (currentProject && data.projectId === currentProject.id) {
                updateFileTree();
            }

            // Show detailed file activity in chat
            if (data.path) {
                const fileName = data.path.split('/').pop();
                if (data.action === 'created') {
                    addChatMessage('ai', `‚ú® Created ${fileName}`);
                } else if (data.action === 'modified') {
                    addChatMessage('ai', `üìù Updated ${fileName}`);
                } else if (data.action === 'deleted') {
                    addChatMessage('ai', `üóëÔ∏è Removed ${fileName}`);
                }
            }
        }

        // Handle quality metric updates
        function handleQualityMetric(data) {
            addBuildLog(`üìà ${data.label}: ${data.value}`);
            updateQualityInsights(data);
        }

        // Handle build complete
        function handleBuildComplete(data) {
            addBuildLog(`‚úÖ Build complete (${data.duration}ms)`);
            addChatMessage('system', `‚úÖ Build complete! Generated ${data.files?.length || 0} files`);

            // Update quality insights with build results
            if (data.files) {
                completeQualityInsights(data.files, data);
            }

            updateFileTree();
            updatePreview();
        }

        // Handle build error
        function handleBuildError(data) {
            addBuildLog(`‚ùå Build error: ${data.error}`);
            addChatMessage('system', `‚ùå Build error: ${data.error}`);

            // Update status to error
            qualityInsightsData.status = 'Error';
            renderQualityInsights();
        }

        // Quality Insights State
        let qualityInsightsData = {
            status: 'Ready',
            buildTime: null,
            qualityScore: null,
            fileCount: 0,
            totalSize: 0,
            technologies: [],
            iterations: 0,
            startTime: null
        };

        // Update quality insights display
        function updateQualityInsights(data) {
            // Handle different data types
            if (data.metric) {
                // WebSocket quality metric update
                if (data.metric === 'quality_score') {
                    qualityInsightsData.qualityScore = data.value;
                }
            } else if (data.result) {
                // Full execution result
                qualityInsightsData.qualityScore = data.result.qualityScore || data.qualityScore;
                qualityInsightsData.iterations = data.result.iterations || data.iterations || 0;
            }

            renderQualityInsights();
        }

        function renderQualityInsights() {
            console.log('üé® Rendering Quality Insights:', qualityInsightsData);

            // Helper to safely update element
            const setElement = (id, value, styleProp, styleValue) => {
                const el = document.getElementById(id);
                if (el) {
                    if (value !== undefined) el.textContent = value;
                    if (styleProp && styleValue) el.style[styleProp] = styleValue;
                }
            };

            // Status
            const statusColor = qualityInsightsData.status === 'Building' ? 'var(--primary)' :
                qualityInsightsData.status === 'Complete' ? 'var(--success)' :
                qualityInsightsData.status === 'Error' ? 'var(--error)' : 'var(--text-secondary)';
            setElement('insight-status', qualityInsightsData.status, 'color', statusColor);

            // Build Time
            if (qualityInsightsData.buildTime !== null) {
                setElement('insight-build-time', `${qualityInsightsData.buildTime}ms`);
            }

            // Quality Score
            if (qualityInsightsData.qualityScore !== null) {
                const score = Math.round(qualityInsightsData.qualityScore * 100);
                setElement('insight-quality-score', `${score}/100`);
                const fill = document.getElementById('insight-quality-fill');
                if (fill) {
                    fill.style.width = `${score}%`;
                    fill.style.background = score >= 80 ? 'var(--success)' : score >= 60 ? 'var(--warning)' : 'var(--error)';
                }
            }

            // File Count
            if (qualityInsightsData.fileCount > 0) {
                setElement('insight-file-count', qualityInsightsData.fileCount);
            }

            // Total Size
            if (qualityInsightsData.totalSize > 0) {
                setElement('insight-total-size', formatBytes(qualityInsightsData.totalSize));
            }

            // Technologies
            if (qualityInsightsData.technologies.length > 0) {
                const techContainer = document.getElementById('insight-technologies');
                if (techContainer) {
                    techContainer.innerHTML = qualityInsightsData.technologies
                        .map(tech => `<span class="tech-badge">${tech}</span>`)
                        .join('');
                }
            }

            // Iterations
            if (qualityInsightsData.iterations > 0) {
                setElement('insight-iterations', `${qualityInsightsData.iterations} ${qualityInsightsData.iterations > 1 ? '(Improved ‚ú®)' : ''}`);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function detectTechnologies(files) {
            const techs = new Set();

            files.forEach(file => {
                if (!file.path) return; // Skip if path is undefined
                const ext = file.path.split('.').pop().toLowerCase();
                const fileName = file.path.toLowerCase();

                // Detect by extension
                if (ext === 'html') techs.add('HTML');
                if (ext === 'css') techs.add('CSS');
                if (ext === 'js' || ext === 'jsx') techs.add('JavaScript');
                if (ext === 'ts' || ext === 'tsx') techs.add('TypeScript');
                if (ext === 'py') techs.add('Python');
                if (ext === 'json') techs.add('JSON');
                if (ext === 'md') techs.add('Markdown');

                // Detect frameworks by filename
                if (fileName.includes('react')) techs.add('React');
                if (fileName.includes('vue')) techs.add('Vue');
                if (fileName.includes('angular')) techs.add('Angular');
                if (fileName === 'package.json') techs.add('Node.js');
                if (fileName === 'requirements.txt') techs.add('Python');
                if (fileName === 'dockerfile') techs.add('Docker');
            });

            return Array.from(techs);
        }

        function resetQualityInsights() {
            qualityInsightsData = {
                status: 'Building',
                buildTime: null,
                qualityScore: null,
                fileCount: 0,
                totalSize: 0,
                technologies: [],
                iterations: 0,
                startTime: Date.now()
            };
            renderQualityInsights();
        }

        function completeQualityInsights(files, execution) {
            console.log('üìä Completing Quality Insights:', { files, execution });

            qualityInsightsData.status = 'Complete';
            qualityInsightsData.buildTime = Date.now() - qualityInsightsData.startTime;
            qualityInsightsData.fileCount = files.length;
            qualityInsightsData.totalSize = files.reduce((sum, f) => sum + (f.size || f.content?.length || 0), 0);
            qualityInsightsData.technologies = detectTechnologies(files);

            if (execution) {
                qualityInsightsData.qualityScore = execution.qualityScore || execution.result?.qualityScore;
                qualityInsightsData.iterations = execution.iterations || execution.result?.iterations || 1;
            }

            console.log('üìä Quality Insights Data:', qualityInsightsData);
            renderQualityInsights();
        }

        // ========================================
        // PROVIDER METRICS
        // ========================================

        async function refreshProviderMetrics() {
            // Helper for safe element updates
            const setEl = (id, text, style) => {
                const el = document.getElementById(id);
                if (el) {
                    if (text !== undefined) el.textContent = text;
                    if (style) Object.assign(el.style, style);
                }
            };

            try {
                const response = await fetch('/api/builder/metrics/provider');
                const result = await response.json();

                if (!result.success) {
                    console.error('Failed to fetch provider metrics:', result.error);
                    setEl('metrics-status', 'Error', { color: 'var(--error)' });
                    return;
                }

                const data = result.data;

                if (!data.enabled) {
                    setEl('metrics-status', 'Disabled', { color: 'var(--text-secondary)' });
                    return;
                }

                // Update status
                setEl('metrics-status', 'Active', { color: 'var(--success)' });

                // Update summary metrics
                const summary = data.summary;
                setEl('metrics-total', summary.totalGenerations || 0);
                setEl('metrics-response-time', summary.avgResponseTime ? `${summary.avgResponseTime}ms` : '‚Äî');
                setEl('metrics-quality', summary.avgQualityScore ? `${summary.avgQualityScore}%` : '‚Äî');
                setEl('metrics-escalations', summary.escalations || 0);

                // Update quality bar
                if (summary.avgQualityScore) {
                    const fill = document.getElementById('metrics-quality-fill');
                    if (fill) fill.style.width = `${summary.avgQualityScore}%`;
                }

                // Update provider usage
                const providerUsage = data.providerUsage;
                const providersDiv = document.getElementById('metrics-providers');
                if (providersDiv) {
                    if (Object.keys(providerUsage).length > 0) {
                        const total = Object.values(providerUsage).reduce((sum, count) => sum + count, 0);
                        const usageHtml = Object.entries(providerUsage)
                            .map(([provider, count]) => {
                                const percentage = Math.round((count / total) * 100);
                                const shortName = provider.replace('ollama-', '').replace('qwen2.5-coder:', '');
                                return `<div style="margin-bottom: 4px;">
                                    <strong>${shortName}</strong>: ${count} (${percentage}%)
                                </div>`;
                            })
                            .join('');
                        providersDiv.innerHTML = usageHtml;
                    } else {
                        providersDiv.innerHTML = '‚Äî';
                    }
                }

                console.log('‚úÖ Provider metrics refreshed');
            } catch (error) {
                console.error('Error refreshing provider metrics:', error);
                setEl('metrics-status', 'Error', { color: 'var(--error)' });
                document.getElementById('metrics-status').style.color = 'var(--error)';
            }
        }

        // Auto-refresh metrics every 10 seconds
        setInterval(refreshProviderMetrics, 10000);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Application Builder Dashboard loaded');
            loadProjects();
            // Monaco editor is now lazy-loaded when Code tab is clicked
            initializeWebSocket();
            initializeColumnResize();
            // Set Planning as default tab in middle panel
            switchMiddleTab('planning');
            // Load provider metrics
            refreshProviderMetrics();
        });

        function initializeMonacoEditor() {
            // Prevent multiple initializations
            if (monacoEditor) {
                console.log('Monaco Editor already initialized');
                return;
            }

            console.log('Initializing Monaco Editor...');
            require(['vs/editor/editor.main'], function () {
                const editorContainer = document.getElementById('code-editor');
                editorContainer.innerHTML = '';

                monacoEditor = monaco.editor.create(editorContainer, {
                    value: '// Select a file from the file browser to edit',
                    language: 'javascript',
                    theme: 'vs-light',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 13,
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    readOnly: true
                });

                console.log('‚úÖ Monaco Editor initialized');
            });
        }

        // Project Management and other functions (unchanged)
        function resetUI() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 100px;">Start building by describing what you want to create</p>';

            const buildLog = document.getElementById('build-log');
            buildLog.innerHTML = '<p style="color: var(--text-secondary);">Ready to build</p>';

            const insights = document.getElementById('quality-insights');
            insights.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">No build yet</p>';

            if (monacoEditor) {
                monacoEditor.setValue('');
                monacoEditor.updateOptions({ readOnly: true });
            }

            const previewIframe = document.getElementById('preview-iframe');
            const previewPlaceholder = document.getElementById('preview-placeholder');
            previewIframe.src = '';
            previewPlaceholder.style.display = 'grid';

            currentBuildId = null;
            currentFilePath = null;
            if (buildPollingInterval) {
                clearInterval(buildPollingInterval);
                buildPollingInterval = null;
            }
        }

        async function newProject() {
            console.log('üìÅ newProject called'); // Debug log
            const name = prompt('Enter project name:');
            if (!name) return;

            const description = prompt('Enter project description (optional):') || '';

            try {
                const response = await fetch('/api/builder/projects/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                const result = await response.json();

                if (result.success) {
                    resetUI();
                    currentProject = result.data;
                    addChatMessage('system', `‚úÖ Project "${name}" created`);
                    updateFileTree();
                    loadProjects(); // Refresh project list
                } else {
                    addChatMessage('system', `‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error creating project:', error);
                addChatMessage('system', `‚ùå Error: ${error.message}`);
            }
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/builder/projects');
                const result = await response.json();

                const projectList = document.getElementById('project-list');

                if (result.success && result.data.length > 0) {
                    projectList.innerHTML = '';
                    result.data.forEach(project => {
                        const projectDiv = document.createElement('div');
                        projectDiv.style.padding = '8px';
                        projectDiv.style.marginBottom = '4px';
                        projectDiv.style.background = 'var(--surface)';
                        projectDiv.style.borderRadius = '6px';
                        projectDiv.style.cursor = 'pointer';
                        projectDiv.style.fontSize = '13px';
                        projectDiv.style.transition = 'all 0.2s';
                        projectDiv.style.display = 'flex';
                        projectDiv.style.justifyContent = 'space-between';
                        projectDiv.style.alignItems = 'center';

                        const contentDiv = document.createElement('div');
                        contentDiv.style.flex = '1';
                        contentDiv.innerHTML = `
                            <div style="font-weight: 500; color: var(--text-primary);">${project.name}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${new Date(project.createdAt).toLocaleDateString()}</div>`;
                        contentDiv.onclick = () => selectProject(project);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = 'üóëÔ∏è';
                        deleteBtn.title = 'Delete project';
                        deleteBtn.style.cssText = 'background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; font-size: 16px; opacity: 0.6; transition: opacity 0.2s;';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteProject(project.id, project.name);
                        };
                        deleteBtn.onmouseenter = () => {
                            deleteBtn.style.opacity = '1';
                            deleteBtn.style.color = 'var(--error)';
                        };
                        deleteBtn.onmouseleave = () => {
                            deleteBtn.style.opacity = '0.6';
                            deleteBtn.style.color = 'var(--text-secondary)';
                        };

                        projectDiv.appendChild(contentDiv);
                        projectDiv.appendChild(deleteBtn);

                        projectDiv.onmouseenter = () => {
                            projectDiv.style.background = 'var(--primary)';
                            projectDiv.style.color = 'white';
                            const textDivs = contentDiv.querySelectorAll('div');
                            textDivs[0].style.color = 'white';
                            textDivs[1].style.color = 'rgba(255,255,255,0.8)';
                        };
                        projectDiv.onmouseleave = () => {
                            if (!currentProject || currentProject.id !== project.id) {
                                projectDiv.style.background = 'var(--surface)';
                                projectDiv.style.color = 'var(--text-primary)';
                                const textDivs = contentDiv.querySelectorAll('div');
                                textDivs[0].style.color = 'var(--text-primary)';
                                textDivs[1].style.color = 'var(--text-secondary)';
                            }
                        };
                        projectList.appendChild(projectDiv);
                    });
                } else {
                    projectList.innerHTML = '<p class="muted-small">No projects yet</p>';
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                const projectList = document.getElementById('project-list');
                projectList.innerHTML = '<p style="color: var(--error); font-size: 13px;">Error loading projects</p>';
            }
        }

        function selectProject(project) {
            resetUI();
            currentProject = project;
            addChatMessage('system', `üìÇ Opened project: ${project.name}`);
            updateFileTree();
        }

        async function deleteProject(projectId, projectName) {
            if (!confirm(`Are you sure you want to delete "${projectName}"?\n\nThis will permanently delete all files in this project.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/builder/projects/${projectId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    addChatMessage('system', `‚úÖ Project "${projectName}" deleted`);

                    // If the deleted project was the current project, clear it
                    if (currentProject && currentProject.id === projectId) {
                        currentProject = null;
                        resetUI();
                    }

                    // Refresh project list
                    loadProjects();
                } else {
                    addChatMessage('error', `‚ùå Failed to delete project: ${result.error}`);
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                addChatMessage('error', `‚ùå Error deleting project: ${error.message}`);
            }
        }

        // Options menu functions
        function toggleOptionsMenu() {
            const menu = document.getElementById('options-menu');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeOptionsMenuOnClickOutside);
                }, 0);
            } else {
                menu.style.display = 'none';
                document.removeEventListener('click', closeOptionsMenuOnClickOutside);
            }
        }

        function closeOptionsMenu() {
            const menu = document.getElementById('options-menu');
            menu.style.display = 'none';
            document.removeEventListener('click', closeOptionsMenuOnClickOutside);
        }

        function closeOptionsMenuOnClickOutside(event) {
            const menu = document.getElementById('options-menu');
            const btn = document.getElementById('options-menu-btn');
            if (!menu.contains(event.target) && !btn.contains(event.target)) {
                closeOptionsMenu();
            }
        }

        function addChatMessage(type, content) {
            const chatMessages = document.getElementById('chat-messages');

            // Clear welcome message on first real message
            const welcomeMsg = chatMessages.querySelector('.chat-message.system');
            if (welcomeMsg && welcomeMsg.textContent.includes('Welcome')) {
                chatMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;

            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);

            const timestamp = document.createElement('div');
            timestamp.className = 'chat-timestamp';
            timestamp.textContent = new Date().toLocaleTimeString();
            messageDiv.appendChild(timestamp);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 100px;">Start building by describing what you want to create below</p>';
            document.getElementById('prompt_composer').value = '';
            document.getElementById('build-log').innerHTML = '<p style="color: var(--text-secondary);">Ready to build</p>';
            conversationHistory = [];
        }

        const DEFAULT_AGENT_PERSONA = `Act as a friendly junior coder in a new app designed to help users build applications. Your role is to be proactive and always think ahead about what users might need. Engage users by asking insightful questions and offering helpful suggestions throughout their coding journey. Focuses on best practices, debugging help, and encouragement.`;
        let agentPersona = localStorage.getItem('agentPersona') || DEFAULT_AGENT_PERSONA;

        function openAgentSettings() { document.getElementById('agent-persona').value = agentPersona; document.getElementById('agent-settings-modal').classList.add('active'); }
        function closeAgentSettings() { document.getElementById('agent-settings-modal').classList.remove('active'); }

        async function openTechnologySettings() { document.getElementById('technology-settings-modal').classList.add('active'); await loadTechnologies(); }
        function closeTechnologySettings() { document.getElementById('technology-settings-modal').classList.remove('active'); }

        async function loadTechnologies() {
            const listEl = document.getElementById('technology-list');
            listEl.innerHTML = '<p class="muted-small">Loading technologies...</p>';
            try {
                const techResponse = await fetch('/api/technologies');
                const techData = await techResponse.json();
                const statusResponse = await fetch('/api/technologies/status');
                const statusData = await statusResponse.json();
                if (!techData.success || !statusData.success) throw new Error('Failed to load technologies');
                const technologies = techData.data; const statuses = statusData.data; const statusMap = {}; statuses.forEach(s => statusMap[s.id] = s);
                listEl.innerHTML = technologies.map(tech => {
                    const status = statusMap[tech.id] || { operational: false, available: false };
                    const isOperational = status.operational; const icon = isOperational ? '‚úÖ' : '‚ùå'; const statusClass = isOperational ? 'operational' : 'not-operational'; const statusText = isOperational ? 'Operational' : 'Not Running';
                    return `
                        <div style="background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; display:flex; gap:20px;">
                            <div style="font-size:32px; width:48px; height:48px; display:grid; place-items:center; border-radius:12px; background:var(--bg-neutral-50); ${isOperational ? 'color: var(--success); background: rgba(52,199,89,.1);' : 'color: var(--error); background: rgba(255,59,48,.1);'}">${icon}</div>
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                                    <div>
                                        <div style="font-size:16px; font-weight:600;">${tech.name}</div>
                                        <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                                            <span style="font-size:12px; ${isOperational ? 'color: var(--success);' : 'color: var(--error);'} font-weight:500;">${statusText}</span>
                                            <span style="font-size:11px; padding:4px 8px; border-radius:6px; ${tech.required ? 'background: rgba(255,149,0,.1); color: var(--warning);' : 'background: rgba(88,86,214,.1); color: var(--secondary);'}">${tech.required ? 'Required' : 'Optional'}</span>
                                            ${status.port ? `<span style="font-size: 11px; color: var(--text-secondary);">Port: ${status.port}</span>` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        ${!isOperational && tech.startCommand ? `<button class=\"btn btn-primary btn-inline\" onclick=\"startTechnology('${tech.id}')\">‚ñ∂Ô∏è Start</button>` : ''}
                                    </div>
                                </div>
                                <div class="muted-small" style="margin-bottom:8px;">${tech.description}</div>
                                <div class="muted-small" style="background: var(--bg-neutral-50); padding:8px 12px; border-radius:8px; margin-bottom:8px;"><strong>Problem Solved:</strong> ${tech.problem}</div>
                                ${tech.paperUrl ? `<a href="${tech.paperUrl}" target="_blank" style="font-size:12px; color: var(--primary); text-decoration:none;">üìÑ ${tech.paperTitle || 'Read Research Paper'} ‚Üí</a>` : ''}
                            </div>
                        </div>`;
                }).join('');
            } catch (error) {
                console.error('Failed to load technologies:', error);
                listEl.innerHTML = `<div style="padding:20px; text-align:center; color: var(--error);"><p>‚ùå Failed to load technologies</p><p class="muted-small" style="margin-top:8px;">${error.message}</p></div>`;
            }
        }

        async function startTechnology(techId) {
            try {
                const response = await fetch(`/api/technologies/${techId}/start`, { method: 'POST' });
                const data = await response.json();
                if (data.success) addChatMessage('system', `‚úÖ ${data.data.message}`); else addChatMessage('system', `‚ùå ${data.error.message}`);
                await loadTechnologies();
            } catch (error) { console.error('Failed to start technology:', error); addChatMessage('system', `‚ùå Failed to start technology: ${error.message}`); }
        }

        async function refreshTechnologies() { await fetch('/api/technologies/cache/clear', { method: 'POST' }); await loadTechnologies(); }

        function saveAgentSettings() {
            const newPersona = document.getElementById('agent-persona').value.trim();
            if (!newPersona) { alert('Please enter an agent persona description'); return; }
            agentPersona = newPersona; localStorage.setItem('agentPersona', agentPersona); closeAgentSettings(); addChatMessage('system', '‚úÖ Agent settings saved! The AI will now use your custom persona.');
        }
        function resetAgentSettings() { if (confirm('Reset to default agent persona?')) { agentPersona = DEFAULT_AGENT_PERSONA; localStorage.removeItem('agentPersona'); document.getElementById('agent-persona').value = DEFAULT_AGENT_PERSONA; addChatMessage('system', 'üîÑ Agent settings reset to default.'); } }

        let conversationHistory = [];
        let qualityMode = false;

        // Mode toggle functions removed - app now always builds

        function toggleQualityMode() {
            qualityMode = !qualityMode;
            const btn = document.getElementById('quality-mode-btn');
            if (btn) {
                if (qualityMode) { btn.textContent = '‚ú® Quality: ON'; btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary'); addChatMessage('system', '‚ú® Quality Mode enabled! Code will be iteratively improved (Pack 11 Phase 2)'); }
                else { btn.textContent = '‚ú® Quality: OFF'; btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); addChatMessage('system', '‚ö° Quality Mode disabled. Using fast generation.'); }
            }
        }

        async function sendBuildRequest() {
            console.log('üöÄ sendBuildRequest called'); // Debug log
            const input = document.getElementById('prompt_composer');
            const request = input.value.trim();

            // Validation with better user feedback
            if (!request) {
                addChatMessage('error', '‚ö†Ô∏è Please enter a build request in the text box above');
                return;
            }

            if (!currentProject) {
                addChatMessage('error', '‚ö†Ô∏è No project selected! Please create a new project first.');
                addChatMessage('system', 'üí° Click the "+ New Project" button in the left sidebar under PROJECTS');
                return;
            }

            // Check server health before building
            const serverHealthy = await checkServerHealth();
            if (!serverHealthy) {
                addChatMessage('error', '‚ùå Server is not responding. Please check if the server is running.');
                addChatMessage('system', 'üí° Start the server with: node dist/index.js');
                return;
            }

            // Build final prompt with UI/UX instructions
            const finalPrompt = buildFinalPrompt(request);

            // Show UI/UX template info if selected
            const templateSelector = document.getElementById('ui_template_selector');
            const customInstructions = document.getElementById('custom_ui_instructions').value.trim();
            if (templateSelector.value || customInstructions) {
                let uiInfo = 'üé® UI/UX: ';
                if (templateSelector.value) {
                    const selectedOption = templateSelector.options[templateSelector.selectedIndex];
                    uiInfo += selectedOption.textContent;
                }
                if (customInstructions) {
                    uiInfo += (templateSelector.value ? ' + ' : '') + 'Custom instructions';
                }
                addChatMessage('system', uiInfo);
            }

            // Add user message and clear input
            addChatMessage('user', request);
            input.value = '';

            // Check if planning.md exists - if not, generate it first
            const planningExists = await checkPlanningExists();

            if (!planningExists) {
                // First request - generate planning.md
                addChatMessage('system', 'üìù Generating project plan...');
                addBuildLog('info', 'Generating planning.md');

                const planGenerated = await generatePlanningMd(finalPrompt);

                if (!planGenerated) {
                    addChatMessage('error', '‚ùå Failed to generate planning.md. Check console for details.');
                    addBuildLog('error', 'Failed to generate planning.md');
                    return;
                }

                addChatMessage('system', '‚úÖ Plan generated! Starting build...');
                addBuildLog('success', 'planning.md created');
            }

            // Always build (no mode toggle)
            console.log('üî® Calling sendBuildExecute...'); // Debug log
            await sendBuildExecute(finalPrompt);
        }

        // Check if server is healthy
        async function checkServerHealth() {
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000) // 5 second timeout
                });
                return response.ok;
            } catch (error) {
                console.error('Server health check failed:', error);
                return false;
            }
        }

        // Check if planning.md exists in current project
        async function checkPlanningExists() {
            if (!currentProject) return false;

            try {
                const response = await fetch(`/api/builder/projects/${currentProject.id}/files`);
                const result = await response.json();

                if (result.success && result.files) {
                    return result.files.some(file => file.name === 'planning.md');
                }
                return false;
            } catch (error) {
                console.error('Error checking planning.md:', error);
                return false;
            }
        }

        // Generate planning.md from user request
        async function generatePlanningMd(request) {
            try {
                console.log('üìù Generating planning.md for request:', request.substring(0, 100));
                console.log('üìù Current project:', currentProject);

                if (!currentProject || !currentProject.id) {
                    console.error('‚ùå No current project selected');
                    addChatMessage('error', '‚ùå Please select or create a project first');
                    return false;
                }

                const response = await fetch('/api/builder/planning/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: request,
                        projectId: currentProject.id
                    })
                });

                console.log('üìù Planning API response status:', response.status);

                const result = await response.json();
                console.log('üìù Planning API result:', result);

                if (result.success && result.planning) {
                    // Update the planning tab with the generated content
                    updatePlanningDisplay(result.planning);

                    // Switch to planning tab to show the user
                    switchMiddleTab('planning');

                    return true;
                } else {
                    console.error('‚ùå Planning generation failed:', result.error);
                    addChatMessage('error', `‚ùå Failed to generate plan: ${result.error || 'Unknown error'}`);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error generating planning.md:', error);
                addChatMessage('error', `‚ùå Error generating plan: ${error.message}`);
                return false;
            }
        }

        // Update the planning display
        function updatePlanningDisplay(planningContent) {
            const planningDiv = document.getElementById('planning-content');
            if (planningDiv) {
                planningDiv.textContent = planningContent;
                planningDiv.style.textAlign = 'left';
            }
        }

        // Chat message function removed - app now always builds

        async function sendBuildExecute(request, isRetry = false) {
            resetQualityInsights(); // Reset insights at build start

            const buildMsg = isRetry
                ? 'üîÑ Retrying build with fixes...'
                : (qualityMode ? '‚ú® Starting build with quality improvement...' : 'ü§î Starting build...');

            addChatMessage('system', buildMsg);
            addBuildLog('info', isRetry ? 'Retrying build' : 'Build started');

            try {
                const response = await fetch('/api/builder/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: request,
                        projectId: currentProject?.id,
                        useQuality: qualityMode
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const { duration, files, qualityScore, iterations, improved } = result.data;

                    // VALIDATION: Check if build actually created files
                    const buildValid = await validateBuildResult(files);

                    if (!buildValid && !isRetry) {
                        // Build reported success but no files created - auto-retry with fix
                        addChatMessage('error', '‚ö†Ô∏è Build completed but no files were created. Retrying with enhanced instructions...');
                        addBuildLog('warning', 'Build validation failed - retrying');

                        // Reset metrics and retry
                        resetQualityInsights();

                        // Enhanced prompt with explicit file creation instructions
                        const enhancedRequest = `${request}

CRITICAL INSTRUCTIONS:
1. You MUST create actual files using the write_file tool
2. Create files in the project directory: projects/${currentProject?.name}/
3. At minimum, create: index.html, styles.css, and script.js
4. Use complete, working code - no placeholders or comments like "add code here"
5. Each file must have actual implementation

Example file paths:
- projects/${currentProject?.name}/index.html
- projects/${currentProject?.name}/styles.css
- projects/${currentProject?.name}/script.js`;

                        // Retry the build
                        setTimeout(() => sendBuildExecute(enhancedRequest, true), 1000);
                        return;
                    }

                    // Success message
                    const durationSec = (duration / 1000).toFixed(1);
                    let successMsg = `‚úÖ Build complete in ${durationSec}s! Generated ${files.length} files`;

                    if (qualityScore) {
                        const qualityPercent = Math.round(qualityScore * 100);
                        successMsg += ` (Quality: ${qualityPercent}%)`;
                    }

                    if (improved && iterations > 1) {
                        successMsg += ` ‚ú® Improved through ${iterations} iterations`;
                    }

                    if (isRetry) {
                        successMsg += ' üîÑ (Fixed on retry)';
                    }

                    addChatMessage('system', successMsg);
                    addBuildLog('success', successMsg);

                    // Update quality insights with build results
                    completeQualityInsights(files, {
                        qualityScore: qualityScore,
                        iterations: iterations || 1,
                        duration: duration
                    });

                    // Update file tree and preview
                    await updateFileTree();
                    await updatePreview();

                    // Switch to preview tab
                    switchWorkspaceTab('preview');

                } else {
                    // Build failed
                    addChatMessage('ai', `‚ùå Build failed: ${result.error}`);
                    addBuildLog('error', `Build failed: ${result.error}`);
                    qualityInsightsData.status = 'Error';
                    renderQualityInsights();
                }

            } catch (error) {
                console.error('Error sending build request:', error);
                addChatMessage('ai', `‚ùå Error: ${error.message}`);
                addBuildLog('error', `Error: ${error.message}`);
                qualityInsightsData.status = 'Error';
                renderQualityInsights();
            }
        }

        // Validate that build actually created files
        async function validateBuildResult(files) {
            if (!files || files.length === 0) {
                console.warn('‚ö†Ô∏è Build validation failed: No files in result');
                return false;
            }

            // Check if files actually exist by trying to fetch file tree
            try {
                const response = await fetch(`/api/builder/projects/${currentProject.id}/files`);
                const result = await response.json();

                if (!result.success) {
                    console.warn('‚ö†Ô∏è Build validation failed: Could not fetch file tree');
                    return false;
                }

                const actualFiles = result.data || [];

                // Filter out metadata files - handle both strings and objects
                const codeFiles = actualFiles.filter(f => {
                    const fileName = typeof f === 'string' ? f : (f.path || f.name || '');
                    return fileName &&
                           !fileName.endsWith('.project.json') &&
                           !fileName.endsWith('README.md') &&
                           !fileName.endsWith('agent-output-debug.txt');
                });

                if (codeFiles.length === 0) {
                    console.warn('‚ö†Ô∏è Build validation failed: No code files created');
                    return false;
                }

                console.log(`‚úÖ Build validation passed: ${codeFiles.length} code files created`);
                return true;
            } catch (error) {
                console.error('Build validation error:', error);
                return false;
            }
        }

        // Legacy endpoints (kept for backward compatibility)
        async function sendBuildWithQuality(request) {
            resetQualityInsights();
            addChatMessage('system', '‚ú® Generating with quality improvement...');
            try {
                const response = await fetch('/api/builder/generate-with-improvement', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: request, projectId: currentProject?.id, maxIterations: 2 }) });
                const result = await response.json();
                if (result.success) {
                    const { code, qualityScore, iterations, improved } = result.data;
                    const qualityPercent = Math.round((qualityScore || 0) * 100);
                    const improvementMsg = improved ? `‚ú® Code improved through ${iterations} iterations (Quality: ${qualityPercent}%)` : `‚úÖ Code generated (Quality: ${qualityPercent}%)`;
                    addChatMessage('system', improvementMsg);
                    addChatMessage('ai', code);
                    addBuildLog('success', improvementMsg);
                    updateQualityInsights({ qualityScore, iterations });
                }
                else { addChatMessage('ai', `‚ùå Error: ${result.error}`); }
            } catch (error) { console.error('Error with quality generation:', error); addChatMessage('ai', `‚ùå Error: ${error.message}`); }
        }

        async function sendBuildDirect(request) {
            resetQualityInsights();
            addChatMessage('system', 'ü§î Analyzing request...');
            try {
                const enhancedTask = `${request}\n\nIMPORTANT: Create all files in the project directory: projects/${currentProject?.name}/\n\nUse the write_file tool to create the following files:\n- index.html (in projects/${currentProject?.name}/)\n- styles.css (in projects/${currentProject?.name}/)\n- script.js (in projects/${currentProject?.name}/)\n\nMake sure to use the write_file tool for each file.`;
                const response = await fetch('/api/agent/execute-async', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task: enhancedTask, userId: 'builder-user' }) });
                const result = await response.json();
                if (result.success) { currentBuildId = result.data.executionId; addChatMessage('system', '‚è≥ Build started...'); addBuildLog('info', 'Build started'); startBuildPolling(); }
                else { addChatMessage('ai', `‚ùå Error: ${result.error}`); }
            } catch (error) { console.error('Error sending build request:', error); addChatMessage('ai', `‚ùå Error: ${error.message}`); }
        }

        function startBuildPolling() {
            if (buildPollingInterval) clearInterval(buildPollingInterval);
            buildPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/agent/status/${currentBuildId}`);
                    const result = await response.json();
                    if (result.success) {
                        const execution = result.data;
                        if (execution.status === 'completed') { clearInterval(buildPollingInterval); handleBuildComplete(execution); }
                        else if (execution.status === 'failed') { clearInterval(buildPollingInterval); handleBuildFailed(execution); }
                    }
                } catch (error) { console.error('Error polling build status:', error); }
            }, 2000);
        }

        async function handleBuildComplete(execution) {
            addChatMessage('ai', '‚úÖ Build completed successfully!');
            addBuildLog('success', 'Build completed');
            if (execution.result && execution.result.output) {
                let outputText = '';
                if (typeof execution.result.output === 'string') outputText = execution.result.output;
                else if (Array.isArray(execution.result.output)) outputText = execution.result.output.map(item => { if (typeof item === 'string') return item; if (item.content) return item.content; if (item.text) return item.text; return JSON.stringify(item, null, 2); }).join('\n\n');
                else outputText = JSON.stringify(execution.result.output, null, 2);
                if (outputText.trim()) addChatMessage('ai', outputText);
            }

            // Get file list for quality insights
            try {
                const response = await fetch(`/api/builder/projects/${currentProject.id}/files`);
                const result = await response.json();
                if (result.success) {
                    completeQualityInsights(result.data, execution);
                }
            } catch (error) {
                console.error('Error getting files for quality insights:', error);
            }

            autoRefreshPreview();
            updateFileTree();
        }

        function handleBuildFailed(execution) { const errorMsg = execution.error || 'Build failed'; addChatMessage('ai', `‚ùå Build failed: ${errorMsg}`); addBuildLog('error', `Build failed: ${errorMsg}`); }

        function addBuildLog(type, message) {
            const buildLog = document.getElementById('build-log');
            if (buildLog.querySelector('p[style*="color: var(--text-secondary)"]')) buildLog.innerHTML = '';
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '4px';
            let icon = '‚ÑπÔ∏è'; let color = 'var(--text-primary)';
            if (type === 'success') { icon = '‚úÖ'; color = 'var(--success)'; }
            else if (type === 'error') { icon = '‚ùå'; color = 'var(--error)'; }
            else if (type === 'warning') { icon = '‚ö†Ô∏è'; color = 'var(--warning)'; }
            logEntry.innerHTML = `<span style="color: var(--text-secondary)">${timestamp}</span> <span style="color: ${color}">${icon} ${message}</span>`;
            buildLog.appendChild(logEntry); buildLog.scrollTop = buildLog.scrollHeight;
        }

        async function updateFileTree() {
            if (!currentProject) { document.getElementById('file-tree').innerHTML = '<p class="muted-small">No project open</p>'; return; }
            try {
                const response = await fetch(`/api/builder/projects/${currentProject.id}/files`);
                const result = await response.json();
                if (result.success) {
                    const fileTree = document.getElementById('file-tree');
                    fileTree.innerHTML = ''; fileTree.className = 'file-tree';
                    renderFileTree(result.data, fileTree);
                }
            } catch (error) { console.error('Error loading file tree:', error); }
        }

        function renderFileTree(items, container, level = 0) {
            items.forEach(item => {
                if (item.type === 'directory') {
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'file-tree-item file-tree-folder';
                    folderDiv.style.paddingLeft = `${level * 12 + 8}px`;
                    const toggle = document.createElement('span'); toggle.className = 'folder-toggle'; toggle.textContent = '‚ñº';
                    const icon = document.createElement('span'); icon.className = 'file-icon'; icon.textContent = 'üìÅ';
                    const name = document.createElement('span'); name.textContent = item.name;
                    folderDiv.appendChild(toggle); folderDiv.appendChild(icon); folderDiv.appendChild(name);
                    const childrenDiv = document.createElement('div'); childrenDiv.className = 'file-tree-children';
                    folderDiv.addEventListener('click', (e) => { e.stopPropagation(); const isOpen = toggle.textContent === '‚ñº'; toggle.textContent = isOpen ? '‚ñ∂' : '‚ñº'; childrenDiv.style.display = isOpen ? 'none' : 'block'; });
                    container.appendChild(folderDiv);
                    if (item.children && item.children.length > 0) { renderFileTree(item.children, childrenDiv, level + 1); container.appendChild(childrenDiv); }
                } else {
                    const fileDiv = document.createElement('div'); fileDiv.className = 'file-tree-item'; fileDiv.style.paddingLeft = `${level * 12 + 32}px`;
                    const icon = document.createElement('span'); icon.className = 'file-icon'; icon.textContent = getFileIcon(item.name);
                    const name = document.createElement('span'); name.textContent = item.name; fileDiv.appendChild(icon); fileDiv.appendChild(name);
                    fileDiv.addEventListener('click', () => { openFile(item.path); document.querySelectorAll('.file-tree-item').forEach(el => el.classList.remove('active')); fileDiv.classList.add('active'); });
                    container.appendChild(fileDiv);
                }
            });
        }

        function getFileIcon(filename) {
            if (!filename) return 'üìÑ';
            const ext = filename.split('.').pop().toLowerCase();
            const icons = { js: 'üìú', ts: 'üìò', json: 'üìã', html: 'üåê', css: 'üé®', md: 'üìù', txt: 'üìÑ', py: 'üêç', java: '‚òï', cpp: '‚öôÔ∏è', c: '‚öôÔ∏è', go: 'üîµ', rs: 'ü¶Ä', sh: 'üîß', yml: '‚öôÔ∏è', yaml: '‚öôÔ∏è', xml: 'üì∞', svg: 'üñºÔ∏è', png: 'üñºÔ∏è', jpg: 'üñºÔ∏è', gif: 'üñºÔ∏è' };
            return icons[ext] || 'üìÑ';
        }

        async function openFile(filePath) {
            if (!monacoEditor) { console.error('Monaco Editor not initialized'); return; }
            try {
                const response = await fetch(`/api/builder/files/${currentProject.id}?path=${encodeURIComponent(filePath)}`);
                if (!response.ok) { addBuildLog('error', `Failed to open file: ${filePath}`); return; }
                const result = await response.json();
                if (result.success) {
                    currentFilePath = filePath;
                    const ext = filePath.split('.').pop().toLowerCase();
                    const languageMap = { js: 'javascript', ts: 'typescript', json: 'json', html: 'html', css: 'css', md: 'markdown', py: 'python', java: 'java', cpp: 'cpp', c: 'c', go: 'go', rs: 'rust', sh: 'shell', yml: 'yaml', yaml: 'yaml', xml: 'xml', txt: 'plaintext' };
                    const language = languageMap[ext] || 'plaintext';
                    monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
                    monacoEditor.setValue(result.data.content);
                    monacoEditor.updateOptions({ readOnly: false });
                    addBuildLog('info', `Opened: ${filePath}`);
                } else { addBuildLog('error', `Error: ${result.error}`); }
            } catch (error) { console.error('Error opening file:', error); addBuildLog('error', `Error opening file: ${error.message}`); }
        }

        async function saveCurrentFile() {
            if (!currentFilePath || !monacoEditor) { alert('No file is currently open'); return; }
            try {
                const content = monacoEditor.getValue();
                const response = await fetch(`/api/builder/files/${currentProject.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: currentFilePath, content }) });
                const result = await response.json();
                if (result.success) addBuildLog('success', `Saved: ${currentFilePath}`); else addBuildLog('error', `Save failed: ${result.error}`);
            } catch (error) { console.error('Error saving file:', error); addBuildLog('error', `Error saving file: ${error.message}`); }
        }

        // Removed duplicate updateQualityInsights - using comprehensive version above

        function refreshPreview() {
            if (!currentProject) { alert('No project is open'); return; }
            const iframe = document.getElementById('preview-iframe');
            const placeholder = document.getElementById('preview-placeholder');
            const previewUrl = `/projects/${currentProject.name}/index.html`;
            iframe.src = previewUrl;
            iframe.onload = () => { placeholder.style.display = 'none'; addBuildLog('info', 'Preview refreshed'); };
            iframe.onerror = () => { placeholder.style.display = 'grid'; addBuildLog('warning', 'No index.html found in project'); };
        }

        function openPreviewInNewTab() { if (!currentProject) { alert('No project is open'); return; } const previewUrl = `/projects/${currentProject.name}/index.html`; window.open(previewUrl, '_blank'); }
        function autoRefreshPreview() { setTimeout(() => { refreshPreview(); switchWorkspaceTab('preview'); }, 500); }
        function updatePreview() { autoRefreshPreview(); }

        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const toggle = content.previousElementSibling.querySelector('.accordion-toggle');
            const isCollapsed = content.classList.contains('collapsed');

            if (isCollapsed) {
                // Expand
                content.classList.remove('collapsed');
                if (toggle) toggle.classList.remove('collapsed');
            } else {
                // Collapse
                content.classList.add('collapsed');
                if (toggle) toggle.classList.add('collapsed');
            }
        }

        function showModeHelp() { document.getElementById('mode-help-modal').style.display = 'flex'; }
        function closeModeHelp() { document.getElementById('mode-help-modal').style.display = 'none'; }

        // Switch between middle panel tabs (Build Log, Preview, Code)
        function switchMiddleTab(name) {
            // Update tab buttons
            document.querySelectorAll('#composer .tab').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === name);
            });

            // Update tab content
            document.querySelectorAll('.middle-panel-tab').forEach(panel => {
                if (panel.id === `middle-tab-${name}`) {
                    panel.style.display = 'flex';
                } else {
                    panel.style.display = 'none';
                }
            });

            // Lazy-load Monaco editor when Code tab is clicked
            if (name === 'code' && !monacoEditor) {
                initializeMonacoEditor();
            }
        }

        // Legacy function kept for compatibility (no longer used)
        function switchWorkspaceTab(name) {
            // This function is now handled by switchMiddleTab
            switchMiddleTab(name);
        }

        document.addEventListener('click', (e) => { const modal = document.getElementById('mode-help-modal'); if (e.target === modal) closeModeHelp(); });
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendBuildRequest(); }
            if ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 's')) { e.preventDefault(); saveCurrentFile(); }
            if (e.key === 'Escape') { closeModeHelp(); }
        });

        // ============================================================
        // PLANNING FUNCTIONS (Pack 7.1)
        // ============================================================

        // Generate PRD with AI
        async function generatePRD() {
            const description = document.getElementById('project-description').value.trim();
            const template = document.getElementById('template-selector').value;

            if (!description) {
                addChatMessage('system', '‚ö†Ô∏è Please enter a project description first');
                return;
            }

            if (!currentProject) {
                addChatMessage('system', '‚ö†Ô∏è Please create or open a project first');
                return;
            }

            try {
                // Show loading state
                const prdEditor = document.getElementById('prd-editor');
                prdEditor.value = '‚è≥ Generating PRD with AI...\n\nThis may take 10-30 seconds depending on your LLM provider...';
                prdEditor.disabled = true;

                addChatMessage('system', 'ü§ñ Generating Product Requirements Document...');

                const response = await fetch('/api/builder/plan/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: currentProject.id,
                        description,
                        template
                    })
                });

                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Server error:', errorText);
                    throw new Error(`Server error (${response.status}): ${errorText}`);
                }

                const result = await response.json();
                console.log('üìã Result:', result);

                if (result.success) {
                    prdEditor.value = result.prd;
                    addChatMessage('assistant', `‚úÖ PRD generated and saved to \`${result.path}\`\n\nYou can now:\n- Edit the PRD directly\n- Break it into tasks\n- Estimate complexity\n- Save changes`);
                    addBuildLog('success', `PRD generated: ${result.path}`);
                } else {
                    throw new Error(result.error || 'Failed to generate PRD');
                }
            } catch (error) {
                console.error('PRD generation error:', error);
                addChatMessage('system', `‚ùå Error: ${error.message}`);
                addBuildLog('error', `PRD generation failed: ${error.message}`);
                document.getElementById('prd-editor').value = '';
            } finally {
                document.getElementById('prd-editor').disabled = false;
            }
        }

        // Break PRD into tasks
        async function breakdownTasks() {
            const prd = document.getElementById('prd-editor').value.trim();

            if (!prd) {
                addChatMessage('system', '‚ö†Ô∏è Please generate or write a PRD first');
                return;
            }

            if (!currentProject) {
                addChatMessage('system', '‚ö†Ô∏è Please create or open a project first');
                return;
            }

            try {
                addChatMessage('system', 'ü§ñ Breaking down PRD into actionable tasks...');

                const response = await fetch('/api/builder/plan/breakdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: currentProject.id,
                        prd
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show results
                    const resultsDiv = document.getElementById('planning-results');
                    const resultsContent = document.getElementById('planning-results-content');

                    resultsContent.innerHTML = `
                        <h4 style="margin-bottom: 12px; color: var(--text-primary);">üìã Task Breakdown</h4>
                        <div style="background: var(--surface); padding: 12px; border-radius: 6px; border: 1px solid var(--border); font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${result.tasks}</div>
                        <div style="margin-top: 12px; padding: 12px; background: var(--bg-info); border-radius: 6px; font-size: 13px;">
                            <strong>üí° Next Steps:</strong>
                            <ul style="margin: 8px 0 0 20px;">
                                <li>Review the tasks above</li>
                                <li>Save the PRD (it includes these tasks)</li>
                                <li>Use these tasks to guide your build prompts</li>
                                <li>Task management UI coming in Pack 7.2!</li>
                            </ul>
                        </div>
                    `;

                    resultsDiv.style.display = 'block';

                    // Scroll to results
                    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                    const taskCount = result.tasks ? result.tasks.split('\n').filter(l => l.trim().startsWith('- [')).length : 0;
                    addChatMessage('assistant', `‚úÖ Generated ${taskCount} tasks from your PRD`);
                    addBuildLog('success', 'Task breakdown complete');
                } else {
                    throw new Error(result.error || 'Failed to break down tasks');
                }
            } catch (error) {
                console.error('Task breakdown error:', error);
                addChatMessage('system', `‚ùå Error: ${error.message}`);
                addBuildLog('error', `Task breakdown failed: ${error.message}`);
            }
        }

        // Estimate complexity
        async function estimateComplexity() {
            const prd = document.getElementById('prd-editor').value.trim();

            if (!prd) {
                addChatMessage('system', '‚ö†Ô∏è Please generate or write a PRD first');
                return;
            }

            if (!currentProject) {
                addChatMessage('system', '‚ö†Ô∏è Please create or open a project first');
                return;
            }

            try {
                addChatMessage('system', 'ü§ñ Analyzing project complexity...');

                const response = await fetch('/api/builder/plan/estimate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: currentProject.id,
                        prd
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const resultsDiv = document.getElementById('planning-results');
                    const resultsContent = document.getElementById('planning-results-content');

                    // Complexity color coding
                    const complexityColors = {
                        'simple': 'var(--success)',
                        'moderate': 'var(--warning)',
                        'complex': 'var(--danger)'
                    };

                    const riskColors = {
                        'low': 'var(--success)',
                        'medium': 'var(--warning)',
                        'high': 'var(--danger)'
                    };

                    resultsContent.innerHTML = `
                        <h4 style="margin-bottom: 16px; color: var(--text-primary);">üìä Complexity Analysis</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <div style="background: var(--surface); padding: 12px; border-radius: 6px; border: 1px solid var(--border); text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px;">Complexity</div>
                                <div style="font-size: 20px; font-weight: 600; color: ${complexityColors[result.complexity] || 'var(--text-primary)'};">${result.complexity}</div>
                            </div>
                            <div style="background: var(--surface); padding: 12px; border-radius: 6px; border: 1px solid var(--border); text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px;">Estimated Time</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--text-primary);">${result.estimatedHours}h</div>
                            </div>
                            <div style="background: var(--surface); padding: 12px; border-radius: 6px; border: 1px solid var(--border); text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px;">Team Size</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--text-primary);">${result.teamSize}</div>
                            </div>
                            <div style="background: var(--surface); padding: 12px; border-radius: 6px; border: 1px solid var(--border); text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px;">Risk Level</div>
                                <div style="font-size: 20px; font-weight: 600; color: ${riskColors[result.riskLevel] || 'var(--text-primary)'};">${result.riskLevel}</div>
                            </div>
                        </div>
                        <div style="background: var(--surface); padding: 12px; border-radius: 6px; border: 1px solid var(--border);">
                            <strong style="color: var(--text-primary);">üí° Recommendations:</strong>
                            <ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">
                                ${result.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                    `;

                    resultsDiv.style.display = 'block';

                    // Scroll to results
                    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                    addChatMessage('assistant', `üìä Complexity: **${result.complexity}** | Est. Time: **${result.estimatedHours} hours** | Risk: **${result.riskLevel}**`);
                    addBuildLog('success', `Complexity: ${result.complexity}, ${result.estimatedHours}h`);
                } else {
                    throw new Error(result.error || 'Failed to estimate complexity');
                }
            } catch (error) {
                console.error('Complexity estimation error:', error);
                addChatMessage('system', `‚ùå Error: ${error.message}`);
                addBuildLog('error', `Complexity estimation failed: ${error.message}`);
            }
        }

        // Save PRD to file
        async function savePRD() {
            const prd = document.getElementById('prd-editor').value.trim();

            if (!prd) {
                addChatMessage('system', '‚ö†Ô∏è Nothing to save');
                return;
            }

            if (!currentProject) {
                addChatMessage('system', '‚ö†Ô∏è Please create or open a project first');
                return;
            }

            try {
                const response = await fetch('/api/builder/plan/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: currentProject.id,
                        content: prd
                    })
                });

                const result = await response.json();

                if (result.success) {
                    addChatMessage('assistant', `‚úÖ PRD saved to \`${result.path}\``);
                    addBuildLog('success', `PRD saved: ${result.path}`);

                    // Refresh file tree to show PRD.md
                    if (currentProject) {
                        loadProjectFiles(currentProject.id);
                    }
                } else {
                    throw new Error(result.error || 'Failed to save PRD');
                }
            } catch (error) {
                console.error('Save PRD error:', error);
                addChatMessage('system', `‚ùå Error: ${error.message}`);
                addBuildLog('error', `Save PRD failed: ${error.message}`);
            }
        }

        // Load example PRD
        function loadExamplePRD() {
            const template = document.getElementById('template-selector').value;

            const examples = {
                'web-app': `# Project: Task Management Web App

## Goal
Build a simple, beautiful task management application for individuals and small teams.

## Core Features
1. Create, edit, and delete tasks
2. Organize tasks into projects
3. Mark tasks as complete
4. Filter and search tasks
5. User authentication

## Technical Requirements
- Frontend: React with TypeScript
- Backend: Node.js + Express
- Database: PostgreSQL
- Authentication: JWT
- Styling: Tailwind CSS

## Success Criteria
- Users can manage tasks efficiently
- App loads in under 2 seconds
- Mobile responsive
- 90%+ test coverage

## Task Breakdown
- [ ] Set up project structure
- [ ] Create database schema
- [ ] Build authentication system
- [ ] Create task CRUD API
- [ ] Build React components
- [ ] Add styling with Tailwind
- [ ] Write unit and integration tests
- [ ] Deploy to production`,

                'rest-api': `# Project: User Management REST API

## Goal
Create a secure, scalable REST API for user management.

## Endpoints
- POST /api/users - Create user
- GET /api/users/:id - Get user
- PUT /api/users/:id - Update user
- DELETE /api/users/:id - Delete user
- POST /api/auth/login - Login
- POST /api/auth/logout - Logout

## Technical Requirements
- Node.js + Express + TypeScript
- PostgreSQL database
- JWT authentication
- Input validation (Zod)
- Rate limiting
- API documentation (Swagger)

## Success Criteria
- All endpoints return proper status codes
- 100% test coverage
- Response time under 100ms
- Proper error handling

## Task Breakdown
- [ ] Set up Express server with TypeScript
- [ ] Create database models
- [ ] Implement JWT authentication
- [ ] Build CRUD endpoints
- [ ] Add input validation
- [ ] Implement rate limiting
- [ ] Write comprehensive tests
- [ ] Generate API documentation`,

                'landing-page': `# Project: Product Landing Page

## Goal
Create a high-converting landing page for a SaaS product.

## Sections
1. Hero with CTA
2. Features showcase
3. Pricing table
4. Testimonials
5. FAQ
6. Footer with links

## Technical Requirements
- HTML5 + CSS3
- Tailwind CSS for styling
- Vanilla JavaScript for interactions
- Mobile-first responsive design
- SEO optimized

## Success Criteria
- Lighthouse score 90+
- Mobile responsive
- Fast load time (<2s)
- Clear call-to-action

## Task Breakdown
- [ ] Create HTML structure
- [ ] Style with Tailwind CSS
- [ ] Add smooth scroll navigation
- [ ] Implement pricing toggle
- [ ] Add form validation
- [ ] Optimize images
- [ ] Test on multiple devices
- [ ] Deploy to Netlify`
            };

            const example = examples[template] || examples['web-app'];
            document.getElementById('prd-editor').value = example;
            addChatMessage('system', `üìÑ Loaded example PRD for ${template}`);
            addBuildLog('info', 'Example PRD loaded');
        }

        // ============================================================
        // UI/UX TEMPLATE FUNCTIONS
        // ============================================================

        let uiTemplates = [];
        let selectedTemplateContent = '';

        /**
         * Load available UI/UX templates from the server
         */
        async function loadUITemplates() {
            try {
                const response = await fetch('/api/builder/ui-templates');
                const data = await response.json();

                if (data.success) {
                    uiTemplates = data.templates;
                    const selector = document.getElementById('ui_template_selector');

                    // Clear existing options except "None"
                    selector.innerHTML = '<option value="">None</option>';

                    // Add template options
                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        selector.appendChild(option);
                    });

                    console.log('‚úÖ Loaded', data.templates.length, 'UI/UX templates');
                }
            } catch (error) {
                console.error('‚ùå Error loading UI templates:', error);
            }
        }

        /**
         * Handle template selection change
         */
        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('ui_template_selector');
            const previewBtn = document.getElementById('preview_template_btn');

            selector.addEventListener('change', async (e) => {
                const templateId = e.target.value;

                if (!templateId) {
                    selectedTemplateContent = '';
                    previewBtn.disabled = true;
                    return;
                }

                // Enable preview button
                previewBtn.disabled = false;

                // Load template content
                try {
                    const response = await fetch(`/api/builder/ui-templates/${templateId}`);
                    const data = await response.json();

                    if (data.success) {
                        selectedTemplateContent = data.template.content;
                        console.log('‚úÖ Loaded template:', data.template.name);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading template content:', error);
                    selectedTemplateContent = '';
                }
            });

            // Load templates on page load
            loadUITemplates();
        });

        /**
         * Preview selected template in a modal
         */
        function previewTemplate() {
            if (!selectedTemplateContent) {
                alert('No template selected');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>üìã Template Preview</h3>
                        <button class="btn" onclick="this.closest('.modal').remove()" style="padding: 8px 16px;">‚úï Close</button>
                    </div>
                    <pre style="background: var(--bg-neutral-50); padding: 16px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; font-size: 13px; line-height: 1.6;">${escapeHtml(selectedTemplateContent)}</pre>
                </div>
            `;
            document.body.appendChild(modal);
        }

        /**
         * Toggle custom UI/UX instructions section
         */
        function toggleCustomUIInstructions() {
            const container = document.getElementById('custom_ui_instructions_container');
            const icon = document.getElementById('custom_ui_toggle_icon');
            const btn = document.getElementById('toggle_custom_ui_btn');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '‚ñ≤';
                btn.querySelector('span:first-child').textContent = '‚ûñ Hide Custom UI/UX Instructions';
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ñº';
                btn.querySelector('span:first-child').textContent = '‚ûï Add Custom UI/UX Instructions';
            }
        }

        /**
         * Escape HTML for safe display
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Build the final prompt with UI/UX instructions
         */
        function buildFinalPrompt(userRequest) {
            const customInstructions = document.getElementById('custom_ui_instructions').value.trim();
            let finalPrompt = '';

            // Add template if selected
            if (selectedTemplateContent) {
                finalPrompt += '[UI/UX GUIDELINES - Apply these design principles to the application]\n\n';
                finalPrompt += selectedTemplateContent;
                finalPrompt += '\n\n';
            }

            // Add custom instructions if provided
            if (customInstructions) {
                finalPrompt += '[ADDITIONAL UI/UX REQUIREMENTS]\n\n';
                finalPrompt += customInstructions;
                finalPrompt += '\n\n';
            }

            // Add separator if we have UI/UX instructions
            if (selectedTemplateContent || customInstructions) {
                finalPrompt += '---\n\n';
                finalPrompt += '[BUILD REQUEST]\n\n';
            }

            // Add user's build request
            finalPrompt += userRequest;

            return finalPrompt;
        }
    </script>

    <!-- Mode Help Modal (preserved) -->
    <div id="mode-help-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3>üéØ Understanding the Modes</h3>
            <h4>üí¨ Chat Mode (Proactive)</h4>
            <p class="muted-small">The AI acts like a helpful assistant who asks questions and gives suggestions.</p>
            <strong>When to use:</strong>
            <ul class="muted-small">
                <li>When you're not sure exactly what you want</li>
                <li>When you want ideas and suggestions</li>
                <li>When you need help planning your project</li>
                <li>When you want to discuss options before building</li>
            </ul>
            <div style="background: var(--bg-neutral-50); border-left: 3px solid var(--primary); padding: 12px; border-radius: 4px; margin: 12px 0;" class="muted-small">
                <strong>Example:</strong><br>
                You: "I want to create a website for my business"<br><br>
                AI: I'd love to help! A few questions: 1) What type of business? 2) Contact form? 3) Responsive? 4) Showcase products or services?
            </div>
            <h4>üî® Build Mode (Direct)</h4>
            <p class="muted-small">The AI immediately starts building what you ask for without asking questions.</p>
            <h4>‚ú® Quality Mode (ON/OFF)</h4>
            <p class="muted-small">When ON, the AI reviews and improves its own code before giving it to you.</p>
            <div style="text-align:center; margin-top: 16px;">
                <button class="btn btn-primary" onclick="closeModeHelp()">Got it!</button>
            </div>
        </div>
    </div>
</body>
</html>